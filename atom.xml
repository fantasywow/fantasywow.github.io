<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>LucKy_one</title>
  
  <subtitle>Always aiming higher</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.liutianhe.com/"/>
  <updated>2019-08-08T06:11:00.870Z</updated>
  <id>http://www.liutianhe.com/</id>
  
  <author>
    <name>Liu Tianhe</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>数据挖掘比赛Handbook</title>
    <link href="http://www.liutianhe.com/blog/data-mining-handbook/"/>
    <id>http://www.liutianhe.com/blog/data-mining-handbook/</id>
    <published>2019-08-08T05:09:13.000Z</published>
    <updated>2019-08-08T06:11:00.870Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/images/数据挖掘竞赛.jpg" alt></p><h2 id="Pandas常用操作"><a href="#Pandas常用操作" class="headerlink" title="Pandas常用操作"></a>Pandas常用操作</h2><p>去重</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BASE_EXCG = BASE_EXCG.drop_duplicates(subset=<span class="literal">None</span>, keep=<span class="string">'first'</span>, inplace=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p>合并</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IDV_TD = pd.merge(IDV_TD, BASE_EXCG, left_on=<span class="string">'CCY_CD'</span>, right_on=<span class="string">'CCY_LETE_CD'</span>, how=<span class="string">'left'</span>)</span><br></pre></td></tr></table></figure><p>删除</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IDV_TD.drop([<span class="string">'RAT_CTG'</span>,<span class="string">'FXDI_SA_ACCM'</span>], axis=<span class="number">1</span>,inplace =<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>运算</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IDV_TD = IDV_TD.eval(<span class="string">'CRBAL_RMB = CRBAL * RMB_MID_PRIC'</span>)</span><br></pre></td></tr></table></figure><p>索引重置</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IDV_TD_after.reset_index()</span><br></pre></td></tr></table></figure><p>修改列名</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IDV_TD_after_after.rename(columns= <span class="keyword">lambda</span> x:x <span class="keyword">if</span> x==<span class="string">'CUST_NO'</span> <span class="keyword">else</span> IDV_TD_<span class="string">'+x).to_csv("./data/IDV_TD_out.csv",index = False)</span></span><br></pre></td></tr></table></figure><p>修改字段类型</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IDV_CUST_BASIC[<span class="string">'OCP_CD'</span>]=IDV_CUST_BASIC[<span class="string">'OCP_CD'</span>].astype(str)</span><br></pre></td></tr></table></figure><p>填充NaN</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IDV_CUST_BASIC[<span class="string">'OCP_CD'</span>].fillna(<span class="string">'NULL'</span>,inplace=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>groupby+join</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IDV_TD_group = IDV_TD.groupby([<span class="string">'CUST_NO'</span>,<span class="string">'DATA_DAT'</span>])</span><br><span class="line">IDV_TD_after = IDV_TD_group.sum().join(IDV_TD_group.size().to_frame(name=<span class="string">'count'</span>)).join(IDV_TD_group[<span class="string">'CRBAL_RMB'</span>].max(),rsuffix = <span class="string">'max'</span>)</span><br></pre></td></tr></table></figure><p>新建一列</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IDV_TD_after_after[<span class="string">'HAS_IDV_TD'</span>] = <span class="number">1</span></span><br></pre></td></tr></table></figure><h2 id="常用编码方式"><a href="#常用编码方式" class="headerlink" title="常用编码方式"></a>常用编码方式</h2><h3 id="One-hot"><a href="#One-hot" class="headerlink" title="One-hot"></a>One-hot</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#one-hot encoding</span></span><br><span class="line">n_columns = [<span class="string">'CCY_CD'</span>,<span class="string">'RDEP_IND_CD'</span>,<span class="string">'ACCT_STS_CD'</span>,<span class="string">'DP_DAY_CD'</span>,<span class="string">'RDEP_DP_DAY_CD'</span>]</span><br><span class="line">dummy_df = pd.get_dummies(IDV_TD[n_columns],columns=n_columns)</span><br><span class="line">IDV_TD = pd.concat([IDV_TD, dummy_df], axis=<span class="number">1</span>)</span><br><span class="line">IDV_TD.drop(n_columns, axis=<span class="number">1</span>,inplace =<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h3 id="Label"><a href="#Label" class="headerlink" title="Label"></a>Label</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#label encoding</span></span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> LabelEncoder</span><br><span class="line">le = LabelEncoder()</span><br><span class="line">DP_DAY_CD_lset = [<span class="string">"Y005"</span>,<span class="string">"Y003"</span>,<span class="string">"Y002"</span>,<span class="string">"Y001"</span>,<span class="string">"M006"</span>,<span class="string">"M003"</span>,<span class="string">"M001"</span>,<span class="string">"D7"</span>,<span class="string">"D1"</span>,<span class="string">"#"</span>,<span class="string">"NULL"</span>]</span><br><span class="line">le.fit(DP_DAY_CD_lset)</span><br><span class="line">IDV_TD[<span class="string">"DP_DAY_CD"</span>] = le.transform(IDV_TD[<span class="string">"DP_DAY_CD"</span>])</span><br><span class="line">IDV_TD[<span class="string">'RDEP_DP_DAY_CD'</span>] = le.transform(IDV_TD[<span class="string">'RDEP_DP_DAY_CD'</span>])</span><br></pre></td></tr></table></figure><h3 id="Mean-encoding"><a href="#Mean-encoding" class="headerlink" title="Mean encoding"></a>Mean encoding</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mean encoding</span></span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> KFold,StratifiedKFold </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MeanEncoder</span>:</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, categorical_features, n_splits=<span class="number">5</span>, target_type=<span class="string">'classification'</span>, prior_weight_func=None)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    :param categorical_features: list of str, the name of the categorical columns to encode</span></span><br><span class="line"><span class="string">    :param n_splits: the number of splits used in mean encoding</span></span><br><span class="line"><span class="string">    :param target_type: str, 'regression' or 'classification'</span></span><br><span class="line"><span class="string">    :param prior_weight_func:</span></span><br><span class="line"><span class="string">    a function that takes in the number of observations, and outputs prior weight</span></span><br><span class="line"><span class="string">    when a dict is passed, the default exponential decay function will be used:</span></span><br><span class="line"><span class="string">    k: the number of observations needed for the posterior to be weighted equally as the prior</span></span><br><span class="line"><span class="string">    f: larger f --&gt; smaller slope</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    self.categorical_features = categorical_features</span><br><span class="line">    self.n_splits = n_splits</span><br><span class="line">    self.learned_stats = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> target_type == <span class="string">'classification'</span>:</span><br><span class="line">        self.target_type = target_type</span><br><span class="line">        self.target_values = []</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        self.target_type = <span class="string">'regression'</span></span><br><span class="line">        self.target_values = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> isinstance(prior_weight_func, dict):</span><br><span class="line">        self.prior_weight_func = eval(<span class="string">'lambda x: 1 / (1 + np.exp((x - k) / f))'</span>, dict(prior_weight_func, np=np))</span><br><span class="line">    <span class="keyword">elif</span> callable(prior_weight_func):</span><br><span class="line">        self.prior_weight_func = prior_weight_func</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        self.prior_weight_func = <span class="keyword">lambda</span> x: <span class="number">1</span> / (<span class="number">1</span> + np.exp((x - <span class="number">2</span>) / <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@staticmethod</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mean_encode_subroutine</span><span class="params">(X_train, y_train, X_test, variable, target, prior_weight_func)</span>:</span></span><br><span class="line">    X_train = X_train[[variable]].copy()</span><br><span class="line">    X_test = X_test[[variable]].copy()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> target <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        nf_name = <span class="string">'&#123;&#125;_pred_&#123;&#125;'</span>.format(variable, target)</span><br><span class="line">        X_train[<span class="string">'pred_temp'</span>] = (y_train == target).astype(int)  <span class="comment"># classification</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        nf_name = <span class="string">'&#123;&#125;_pred'</span>.format(variable)</span><br><span class="line">        X_train[<span class="string">'pred_temp'</span>] = y_train  <span class="comment"># regression</span></span><br><span class="line"></span><br><span class="line">    prior = X_train[<span class="string">'pred_temp'</span>].mean()</span><br><span class="line">    col_avg_y = X_train.groupby(by=variable, axis=<span class="number">0</span>)[<span class="string">'pred_temp'</span>].agg(&#123;<span class="string">'mean'</span>: <span class="string">'mean'</span>, <span class="string">'beta'</span>: <span class="string">'size'</span>&#125;)</span><br><span class="line">    col_avg_y[<span class="string">'beta'</span>] = prior_weight_func(col_avg_y[<span class="string">'beta'</span>])</span><br><span class="line">    col_avg_y[nf_name] = col_avg_y[<span class="string">'beta'</span>] * prior + (<span class="number">1</span> - col_avg_y[<span class="string">'beta'</span>]) * col_avg_y[<span class="string">'mean'</span>]</span><br><span class="line">    col_avg_y.drop([<span class="string">'beta'</span>, <span class="string">'mean'</span>], axis=<span class="number">1</span>, inplace=<span class="literal">True</span>)</span><br><span class="line">    nf_train = X_train.join(col_avg_y, on=variable)[nf_name].values</span><br><span class="line">    nf_test = X_test.join(col_avg_y, on=variable).fillna(prior, inplace=<span class="literal">False</span>)[nf_name].values</span><br><span class="line">    <span class="keyword">return</span> nf_train, nf_test, prior, col_avg_y</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fit_transform</span><span class="params">(self, X, y)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    :param X: pandas DataFrame, n_samples * n_features</span></span><br><span class="line"><span class="string">    :param y: pandas Series or numpy array, n_samples</span></span><br><span class="line"><span class="string">    :return X_new: the transformed pandas DataFrame containing mean-encoded categorical features</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    X_new = X.copy()</span><br><span class="line">    <span class="keyword">if</span> self.target_type == <span class="string">'classification'</span>:</span><br><span class="line">        skf = StratifiedKFold(self.n_splits)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        skf = KFold(self.n_splits)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> self.target_type == <span class="string">'classification'</span>:</span><br><span class="line">        self.target_values = sorted(set(y))</span><br><span class="line">        self.learned_stats = &#123;<span class="string">'&#123;&#125;_pred_&#123;&#125;'</span>.format(variable, target): [] <span class="keyword">for</span> variable, target <span class="keyword">in</span></span><br><span class="line">                              itertools.product(self.categorical_features, self.target_values)&#125;</span><br><span class="line">        <span class="keyword">for</span> variable, target <span class="keyword">in</span> itertools.product(self.categorical_features, self.target_values):</span><br><span class="line">            nf_name = <span class="string">'&#123;&#125;_pred_&#123;&#125;'</span>.format(variable, target)</span><br><span class="line">            X_new.loc[:, nf_name] = np.nan</span><br><span class="line">            <span class="keyword">for</span> large_ind, small_ind <span class="keyword">in</span> skf.split(y, y):</span><br><span class="line">                nf_large, nf_small, prior, col_avg_y = MeanEncoder.mean_encode_subroutine(</span><br><span class="line">                    X_new.iloc[large_ind], y.iloc[large_ind], X_new.iloc[small_ind], variable, target, self.prior_weight_func)</span><br><span class="line">                X_new.iloc[small_ind, <span class="number">-1</span>] = nf_small</span><br><span class="line">                self.learned_stats[nf_name].append((prior, col_avg_y))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        self.learned_stats = &#123;<span class="string">'&#123;&#125;_pred'</span>.format(variable): [] <span class="keyword">for</span> variable <span class="keyword">in</span> self.categorical_features&#125;</span><br><span class="line">        <span class="keyword">for</span> variable <span class="keyword">in</span> self.categorical_features:</span><br><span class="line">            nf_name = <span class="string">'&#123;&#125;_pred'</span>.format(variable)</span><br><span class="line">            X_new.loc[:, nf_name] = np.nan</span><br><span class="line">            <span class="keyword">for</span> large_ind, small_ind <span class="keyword">in</span> skf.split(y, y):</span><br><span class="line">                nf_large, nf_small, prior, col_avg_y = MeanEncoder.mean_encode_subroutine(</span><br><span class="line">                    X_new.iloc[large_ind], y.iloc[large_ind], X_new.iloc[small_ind], variable, <span class="literal">None</span>, self.prior_weight_func)</span><br><span class="line">                X_new.iloc[small_ind, <span class="number">-1</span>] = nf_small</span><br><span class="line">                self.learned_stats[nf_name].append((prior, col_avg_y))</span><br><span class="line">    <span class="keyword">return</span> X_new</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">transform</span><span class="params">(self, X)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    :param X: pandas DataFrame, n_samples * n_features</span></span><br><span class="line"><span class="string">    :return X_new: the transformed pandas DataFrame containing mean-encoded categorical features</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    X_new = X.copy()</span><br><span class="line">    <span class="keyword">if</span> self.target_type == <span class="string">'classification'</span>:</span><br><span class="line">        <span class="keyword">for</span> variable, target <span class="keyword">in</span> itertools.product(self.categorical_features, self.target_values[:<span class="number">-1</span>]):</span><br><span class="line">            nf_name = <span class="string">'&#123;&#125;_pred_&#123;&#125;'</span>.format(variable, target)</span><br><span class="line">            X_new[nf_name] = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> prior, col_avg_y <span class="keyword">in</span> self.learned_stats[nf_name]:</span><br><span class="line">                X_new[nf_name] += X_new[[variable]].join(col_avg_y, on=variable).fillna(prior, inplace=<span class="literal">False</span>)[nf_name]</span><br><span class="line">            X_new[nf_name] /= self.n_splits</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> variable <span class="keyword">in</span> self.categorical_features:</span><br><span class="line">            nf_name = <span class="string">'&#123;&#125;_pred'</span>.format(variable)</span><br><span class="line">            X_new[nf_name] = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> prior, col_avg_y <span class="keyword">in</span> self.learned_stats[nf_name]:</span><br><span class="line">                X_new[nf_name] += X_new[[variable]].join(col_avg_y, on=variable).fillna(prior, inplace=<span class="literal">False</span>)[nf_name]</span><br><span class="line">            X_new[nf_name] /= self.n_splits</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> X_new</span><br></pre></td></tr></table></figure><p>使用:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mean-encoding</span></span><br><span class="line">MeanEncodeFeature = [<span class="string">'PROV_CD'</span>,<span class="string">'NATN_CD'</span>,<span class="string">'CULT_DGR_CD'</span>,<span class="string">'SPEC_TECH_PRFN_QUA_CD'</span>,<span class="string">'OCP_CD'</span>,<span class="string">'RES_CD'</span>]</span><br><span class="line">ME = MeanEncoder(MeanEncodeFeature)</span><br><span class="line">ME.fit_transform(IDV_CUST_BASIC_train,IDV_y)</span><br><span class="line">IDV_CUST_BASIC = ME.transform(IDV_CUST_BASIC)</span><br></pre></td></tr></table></figure><h2 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h2><h3 id="训练集验证集划分"><a href="#训练集验证集划分" class="headerlink" title="训练集验证集划分"></a>训练集验证集划分</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line">X_dtrain ,X_deval,Y_dtrain,Y_deval = train_test_split(X_train,Y_train,test_size=<span class="number">0.3</span>,random_state=<span class="number">1024</span>,stratify=Y_train)</span><br></pre></td></tr></table></figure><h3 id="LightGBM"><a href="#LightGBM" class="headerlink" title="LightGBM"></a>LightGBM</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lightgbm <span class="keyword">as</span> lgb  </span><br><span class="line"><span class="keyword">import</span> pickle  </span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> roc_auc_score  </span><br><span class="line"></span><br><span class="line">lgb_train = lgb.Dataset(X_dtrain, Y_dtrain)  </span><br><span class="line">lgb_eval = lgb.Dataset(X_deval, Y_deval)  </span><br><span class="line"></span><br><span class="line">params = &#123;  </span><br><span class="line">    <span class="string">'boosting_type'</span>: <span class="string">'gbdt'</span>,  </span><br><span class="line">    <span class="string">'objective'</span>: <span class="string">'binary'</span>,  </span><br><span class="line">    <span class="string">'metric'</span>: <span class="string">'auc'</span>, </span><br><span class="line">    <span class="string">'num_leaves'</span>: <span class="number">20</span>,  </span><br><span class="line">    <span class="string">'max_depth'</span>: <span class="number">5</span>,  </span><br><span class="line">    <span class="string">'min_data_in_leaf'</span>: <span class="number">20</span>,  </span><br><span class="line">    <span class="string">'learning_rate'</span>: <span class="number">0.02</span>,  </span><br><span class="line">    <span class="string">'feature_fraction'</span>: <span class="number">0.9</span>,  </span><br><span class="line">    <span class="string">'bagging_fraction'</span>: <span class="number">0.9</span>,  </span><br><span class="line">    <span class="string">'bagging_freq'</span>: <span class="number">5</span>,  </span><br><span class="line">    <span class="string">'lambda_l1'</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">'lambda_l2'</span>: <span class="number">0.001</span>,</span><br><span class="line">    <span class="string">'min_gain_to_split'</span>: <span class="number">0.2</span>,  </span><br><span class="line">    <span class="string">'verbose'</span>: <span class="number">5</span>,  </span><br><span class="line">    <span class="string">'is_unbalance'</span>: <span class="literal">True</span>, <span class="comment">#重要</span></span><br><span class="line">    <span class="string">'random_state'</span> : <span class="number">1024</span></span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">gbm = lgb.train(params,  </span><br><span class="line">                lgb_train,  </span><br><span class="line">                num_boost_round=<span class="number">2000</span>,  </span><br><span class="line">                valid_sets=lgb_eval,  </span><br><span class="line">                early_stopping_rounds=<span class="number">200</span>)</span><br></pre></td></tr></table></figure><h3 id="导出特征重要性"><a href="#导出特征重要性" class="headerlink" title="导出特征重要性"></a>导出特征重要性</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">importance = gbm.feature_importance()  </span><br><span class="line">names = gbm.feature_name()  </span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'./feature_importance.txt'</span>, <span class="string">'w+'</span>) <span class="keyword">as</span> file: </span><br><span class="line">    <span class="keyword">for</span> index, im <span class="keyword">in</span> enumerate(importance):  </span><br><span class="line">        string = names[index] + <span class="string">', '</span> + str(im) + <span class="string">'\n'</span>  </span><br><span class="line">        file.write(string)</span><br></pre></td></tr></table></figure><h3 id="保存模型"><a href="#保存模型" class="headerlink" title="保存模型"></a>保存模型</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gbm.save_model(<span class="string">'./model.txt'</span>)</span><br></pre></td></tr></table></figure><p>KFOLD</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> KFold</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> roc_auc_score</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> f1_score</span><br><span class="line"><span class="keyword">import</span> lightgbm <span class="keyword">as</span> lgb</span><br><span class="line"><span class="keyword">import</span> gc</span><br><span class="line"></span><br><span class="line"><span class="comment"># Extract feature names</span></span><br><span class="line">feature_names = list(X_train.columns)</span><br><span class="line"><span class="comment"># Create the kfold object</span></span><br><span class="line">k_fold = KFold(n_splits = <span class="number">5</span>, shuffle = <span class="literal">True</span>, random_state = <span class="number">50</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># Empty array for feature importances</span></span><br><span class="line">feature_importance_values = np.zeros(len(feature_names))</span><br><span class="line">    </span><br><span class="line"><span class="comment"># Empty array for test predictions</span></span><br><span class="line">target_predictions = np.zeros(target.shape[<span class="number">0</span>])</span><br><span class="line">    </span><br><span class="line"><span class="comment"># Empty array for out of fold validation predictions</span></span><br><span class="line">out_of_fold = np.zeros(X_train.shape[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">valid_f1 = []</span><br><span class="line">valid_threshold = []</span><br><span class="line">valid_auc = []</span><br><span class="line"><span class="comment"># Iterate through each fold</span></span><br><span class="line"><span class="keyword">for</span> train_indices, valid_indices <span class="keyword">in</span> k_fold.split(X_train):</span><br><span class="line">    print(<span class="string">'开始一次迭代'</span>)</span><br><span class="line">    <span class="comment"># Training data for the fold</span></span><br><span class="line">    train_features, train_labels = X_train.iloc[train_indices], Y_train.iloc[train_indices]</span><br><span class="line">    <span class="comment"># Validation data for the fold</span></span><br><span class="line">    valid_features, valid_labels = X_train.iloc[valid_indices], Y_train.iloc[valid_indices]</span><br><span class="line">    lgb_train = lgb.Dataset(train_features, train_labels)  </span><br><span class="line">    lgb_eval = lgb.Dataset(valid_features, valid_labels)  </span><br><span class="line">    params = &#123;  </span><br><span class="line">    <span class="string">'boosting_type'</span>: <span class="string">'gbdt'</span>,  </span><br><span class="line">    <span class="string">'objective'</span>: <span class="string">'binary'</span>,  </span><br><span class="line">    <span class="string">'metric'</span>: <span class="string">'auc'</span>, </span><br><span class="line">    <span class="string">'num_leaves'</span>: <span class="number">30</span>,  </span><br><span class="line">    <span class="string">'max_depth'</span>: <span class="number">6</span>,  </span><br><span class="line">    <span class="string">'min_data_in_leaf'</span>: <span class="number">20</span>,  </span><br><span class="line">    <span class="string">'learning_rate'</span>: <span class="number">0.01</span>,  </span><br><span class="line">    <span class="string">'feature_fraction'</span>: <span class="number">0.9</span>,  </span><br><span class="line">    <span class="string">'bagging_fraction'</span>: <span class="number">0.9</span>,  </span><br><span class="line">    <span class="string">'bagging_freq'</span>: <span class="number">5</span>,  </span><br><span class="line">    <span class="string">'lambda_l1'</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">'lambda_l2'</span>: <span class="number">0.001</span>,</span><br><span class="line">    <span class="string">'min_gain_to_split'</span>: <span class="number">0.2</span>,  </span><br><span class="line">    <span class="string">'verbose'</span>: <span class="number">5</span>,  </span><br><span class="line">    <span class="string">'is_unbalance'</span>: <span class="literal">True</span>, <span class="comment">#重要</span></span><br><span class="line">    <span class="string">'random_state'</span> : <span class="number">1024</span></span><br><span class="line">    &#125;  </span><br><span class="line">    gbm = lgb.train(params,  </span><br><span class="line">                lgb_train,  </span><br><span class="line">                num_boost_round=<span class="number">2000</span>,  </span><br><span class="line">                verbose_eval = <span class="literal">False</span>,</span><br><span class="line">                valid_sets=lgb_eval,  </span><br><span class="line">                early_stopping_rounds=<span class="number">200</span>)  </span><br><span class="line">    </span><br><span class="line">    pred_train = gbm.predict(valid_features, num_iteration=gbm.best_iteration) </span><br><span class="line">    pred_train =  pd.DataFrame(pred_train)</span><br><span class="line">    maxf1 = <span class="number">0</span></span><br><span class="line">    maxi = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> np.arange(<span class="number">0.2</span>,<span class="number">0.8</span>,<span class="number">0.001</span>):</span><br><span class="line">        temp = pd.DataFrame(pred_train[<span class="number">0</span>].apply(<span class="keyword">lambda</span> x:<span class="number">1</span> <span class="keyword">if</span> x&gt;i <span class="keyword">else</span> <span class="number">0</span>))</span><br><span class="line">        score = f1_score(valid_labels,temp)</span><br><span class="line">        <span class="keyword">if</span> score &gt;maxf1 :</span><br><span class="line">            maxf1 = score</span><br><span class="line">            maxi = i</span><br><span class="line">    valid_f1.append(maxf1)</span><br><span class="line">    valid_threshold.append(maxi)</span><br><span class="line">    <span class="comment"># Record the best iteration</span></span><br><span class="line">    best_iteration = gbm.best_iteration</span><br><span class="line">    valid_auc.append(gbm.best_score[<span class="string">'valid_0'</span>][<span class="string">'auc'</span>])</span><br><span class="line">    <span class="comment"># Record the feature importances</span></span><br><span class="line">    feature_importance_values += gbm.feature_importance() / k_fold.n_splits</span><br><span class="line">    <span class="comment"># Make predictions</span></span><br><span class="line">    target_predictions += gbm.predict(target, num_iteration = best_iteration) / k_fold.n_splits   </span><br><span class="line">    <span class="comment"># Record the out of fold predictions</span></span><br><span class="line">    out_of_fold[valid_indices] = gbm.predict(valid_features, num_iteration = best_iteration)  </span><br><span class="line">    <span class="comment"># Clean up memory</span></span><br><span class="line">    gc.enable()</span><br><span class="line">    <span class="keyword">del</span> gbm, train_features, valid_features</span><br><span class="line">    gc.collect()</span><br><span class="line"></span><br><span class="line">print(valid_f1,np.mean(valid_f1))</span><br><span class="line">print(valid_threshold,np.mean(valid_threshold))</span><br><span class="line">print(valid_auc,np.mean(valid_auc))</span><br></pre></td></tr></table></figure><h3 id="StackNet"><a href="#StackNet" class="headerlink" title="StackNet"></a>StackNet</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lightgbm <span class="keyword">as</span> lgb  </span><br><span class="line"></span><br><span class="line">lightgbm = lgb.LGBMClassifier(    </span><br><span class="line">    boosting_type= <span class="string">'gbdt'</span>,  </span><br><span class="line">    objective= <span class="string">'binary'</span>,  </span><br><span class="line">    metric= <span class="string">'auc'</span>, </span><br><span class="line">    num_leaves= <span class="number">20</span>,  </span><br><span class="line">    max_depth= <span class="number">5</span>,  </span><br><span class="line">    min_data_in_leaf= <span class="number">20</span>,  </span><br><span class="line">    learning_rate= <span class="number">0.02</span>,  </span><br><span class="line">    feature_fraction= <span class="number">0.9</span>,  </span><br><span class="line">    bagging_fraction=<span class="number">0.9</span>,  </span><br><span class="line">    bagging_freq= <span class="number">5</span>,  </span><br><span class="line">    lambda_l1=<span class="number">1</span>,</span><br><span class="line">    lambda_l2=<span class="number">0.001</span>,</span><br><span class="line">    min_gain_to_split= <span class="number">0.2</span>,  </span><br><span class="line">    verbose=<span class="number">5</span>,  </span><br><span class="line">    is_unbalance=<span class="literal">True</span>, </span><br><span class="line">    random_state=<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> xgboost <span class="keyword">as</span> xgb</span><br><span class="line"></span><br><span class="line">xgboost_gbtree = xgb.XGBClassifier(</span><br><span class="line">    booster=<span class="string">'gbtree'</span>,</span><br><span class="line">    objective=<span class="string">'binary:logistic'</span>,</span><br><span class="line">    n_estimators = <span class="number">500</span>,</span><br><span class="line">    learning_rate = <span class="number">0.1</span>,</span><br><span class="line">    subsample= <span class="number">0.9</span>,</span><br><span class="line">    colsample_bytree= <span class="number">0.9</span>,</span><br><span class="line">    min_child_weight=<span class="number">2</span>,</span><br><span class="line">    max_depth= <span class="number">7</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> GridSearchCV</span><br><span class="line"><span class="keyword">from</span> catboost <span class="keyword">import</span> CatBoostClassifier</span><br><span class="line"></span><br><span class="line">param_cb = &#123;</span><br><span class="line">        <span class="string">'learning_rate'</span>: <span class="number">0.15</span>,</span><br><span class="line">        <span class="string">'bagging_temperature'</span>: <span class="number">0.1</span>, </span><br><span class="line">        <span class="string">'l2_leaf_reg'</span>: <span class="number">4</span>,</span><br><span class="line">        <span class="string">'depth'</span>: <span class="number">7</span>, </span><br><span class="line">        <span class="string">'iterations'</span> : <span class="number">300</span>,</span><br><span class="line">        <span class="string">'task_type'</span>:<span class="string">'CPU'</span>,</span><br><span class="line">        <span class="string">'loss_function'</span> : <span class="string">"CrossEntropy"</span>,</span><br><span class="line">        <span class="string">'eval_metric'</span> : <span class="string">"AUC"</span>,</span><br><span class="line">        <span class="comment">#'bootstrap_type' : 'Bayesian',</span></span><br><span class="line">        <span class="comment">#'random_seed':42,</span></span><br><span class="line">        <span class="comment">#'early_stopping_rounds' : 100,</span></span><br><span class="line">&#125;</span><br><span class="line">clf_ctb = CatBoostClassifier(**param_cb)</span><br><span class="line"></span><br><span class="line">models = [  <span class="comment">######## First level ########</span></span><br><span class="line">            [xgboost_gbtree, clf_ctb, lightgbm],</span><br><span class="line">            <span class="comment">######## Second level ########</span></span><br><span class="line">            [lightgbm],</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pystacknet.pystacknet <span class="keyword">import</span> StackNetClassifier</span><br><span class="line"></span><br><span class="line">model = StackNetClassifier(</span><br><span class="line">    models,</span><br><span class="line">    metric=<span class="string">"auc"</span>,</span><br><span class="line">    folds=<span class="number">3</span>,</span><br><span class="line">    restacking=<span class="literal">True</span>,</span><br><span class="line">    use_retraining=<span class="literal">True</span>,</span><br><span class="line">    use_proba=<span class="literal">True</span>,</span><br><span class="line">    random_state=<span class="number">42</span>,</span><br><span class="line">    verbose=<span class="number">1</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">model.fit(X_dtrain, Y_dtrain)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      参加数据挖掘比赛的总结
    
    </summary>
    
    
      <category term="python" scheme="http://www.liutianhe.com/tags/python/"/>
    
      <category term="pandas" scheme="http://www.liutianhe.com/tags/pandas/"/>
    
  </entry>
  
  <entry>
    <title>2018闲书阅读书目</title>
    <link href="http://www.liutianhe.com/blog/2018-reading-list/"/>
    <id>http://www.liutianhe.com/blog/2018-reading-list/</id>
    <published>2018-12-21T13:37:56.000Z</published>
    <updated>2018-12-31T14:39:56.859Z</updated>
    
    <content type="html"><![CDATA[<p><strong>《思维的发现》</strong><br><img src="https://img3.doubanio.com/view/subject/l/public/s29787624.jpg" alt><br><strong>《为什么精英都是时间控》</strong><br><img src="https://img3.doubanio.com/view/subject/l/public/s29733031.jpg" alt><br><strong>《止损：如何克服贪婪和恐惧》</strong><br><img src="https://img3.doubanio.com/view/subject/l/public/s28843471.jpg" alt><br><strong>《黑天鹅 如何应对不可预知的未来（升级版）》</strong><br><img src="https://img1.doubanio.com/view/subject/l/public/s6995839.jpg" alt><br><strong>《投资中不简单的事》</strong><br><img src="https://img1.doubanio.com/view/subject/l/public/s29700059.jpg" alt><br><strong>《投资中最简单的事》</strong><br><img src="https://img3.doubanio.com/view/subject/l/public/s27653114.jpg" alt><br><strong>《M型社会》</strong><br><img src="https://img3.doubanio.com/view/subject/l/public/s28259076.jpg" alt><br><strong>《高频交易员：华尔街的速度游戏》</strong><br><img src="https://img3.doubanio.com/view/subject/l/public/s28043882.jpg" alt><br><strong>《耶路撒冷三千年》</strong><br><img src="https://img3.doubanio.com/view/subject/l/public/s27762150.jpg" alt><br><strong>《高盛小道消息》</strong><br><img src="https://img3.doubanio.com/view/subject/l/public/s29535383.jpg" alt><br><strong>《哈佛·庆应超强逻辑谈判技巧》</strong><br><img src="https://img3.doubanio.com/view/subject/l/public/s29712560.jpg" alt></p>]]></content>
    
    <summary type="html">
    
      2018读过的那些闲书。
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>智能投顾</title>
    <link href="http://www.liutianhe.com/blog/Robo-Advisor/"/>
    <id>http://www.liutianhe.com/blog/Robo-Advisor/</id>
    <published>2018-04-05T06:39:36.000Z</published>
    <updated>2018-04-05T09:51:51.245Z</updated>
    
    <content type="html"><![CDATA[<p>构建智能投顾系统的一些感悟</p><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>1.马科维茨均值方差模型奠定了现代投资组合理论，后来人的各种模型也都没有脱离用风险和回报两个维度来衡量一种资产。<br>2.在中国能够覆盖绝大多数种类的资产的就只有公募基金。<br>3.通过公募基金组建投资组合又面临一个问题，是选用被动型的公募基金还是主动型公募基金，也就是选择投指数还是试图寻找更好的主动管理的公募基金来寻求超额收益。</p><h2 id="智能投顾-VS-FOF"><a href="#智能投顾-VS-FOF" class="headerlink" title="智能投顾 VS FOF"></a>智能投顾 VS FOF</h2><p>1.FOF更加标准化。<br>2.智能投顾的持仓以及变动更加透明，调仓需要客户授权。<br>3.智能投顾理想的千人千面看似很美好，个人感觉实际上却很难做到（大多数人的实际风险承受能力和他自己认为的承受能力并不匹配）</p><h2 id="模型："><a href="#模型：" class="headerlink" title="模型："></a>模型：</h2><p>1.最优比例-根据金融模型算出最优的资产配置比例，触发调仓的信号。<br>2.基金池-如果选择主动型公募基金还涉及到是量化选基金还是依赖经验主义选基金。</p><h2 id="交易系统："><a href="#交易系统：" class="headerlink" title="交易系统："></a>交易系统：</h2><p>1.申购赎回调仓是一组交易，其中一只交易失败时的处理方案。<br>2.考虑首次追加最小申购金额，最低留存，步长等公募基金限制（理想情况是选择那些限制可以忽略的公募基金，避免申购赎回调仓时的一系列衍生的交易金额限制）。<br>3.分级的货币基金，升级降级时引发的各种问题。（如果智能投顾系统和原有的基金代销系统使用同一基金交易账号，就不可避免这面对这一坑爹问题）<br>4.在不考虑垫资的情况下，调仓是一个漫长的过程。。。申购的金额、基金都是可能发生变化的，要有一套完整的调仓交易调度规则。<br>5.基金暂停申购的处理，有短期的暂停申购（节假日前的货币基金），有长期的暂停申购，要分别处理。</p><hr><p>先写这么多以后再补充</p>]]></content>
    
    <summary type="html">
    
      构建智能投顾系统的一些感悟
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>2017闲书阅读书目</title>
    <link href="http://www.liutianhe.com/blog/2017-reading-list/"/>
    <id>http://www.liutianhe.com/blog/2017-reading-list/</id>
    <published>2018-02-21T13:37:56.000Z</published>
    <updated>2018-12-15T07:28:52.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>《星巴克-关于咖啡、商业和文化的传奇》</strong><br><img src="https://img1.doubanio.com/lpic/s27283098.jpg" alt><br><strong>《随机漫步的傻瓜》</strong><br><img src="https://img1.doubanio.com/lpic/s10406068.jpg" alt><br><strong>《像TED一样演讲》</strong><br><img src="https://img1.doubanio.com/lpic/s29591237.jpg" alt><br><strong>《红色资本-中国的非凡崛起与脆弱的金融基础》</strong><br><img src="https://img1.doubanio.com/lpic/s27033677.jpg" alt><br><strong>《斜杠青年-如何开启你的多重身份》</strong><br><img src="https://img1.doubanio.com/lpic/s29221578.jpg" alt><br><strong>《有效资产管理》</strong><br><img src="https://img3.doubanio.com/lpic/s25496345.jpg" alt><br><strong>《激荡三十年》</strong><br><img src="https://img3.doubanio.com/lpic/s27433242.jpg" alt><br><img src="https://img3.doubanio.com/lpic/s27435865.jpg" alt><br><strong>《时运变迁》</strong><br><img src="https://img1.doubanio.com/lpic/s29412297.jpg" alt><br><strong>《硅谷钢铁侠》</strong><br><img src="https://img3.doubanio.com/lpic/s28571694.jpg" alt><br><strong>《助推》</strong><br><img src="https://img1.doubanio.com/lpic/s28066358.jpg" alt><br><strong>《信号》</strong><br><img src="https://img3.doubanio.com/lpic/s29554713.jpg" alt><br><strong>《腾讯传》</strong><br><img src="https://img3.doubanio.com/lpic/s29653026.jpg" alt></p>]]></content>
    
    <summary type="html">
    
      2017读过的那些闲书。
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>JDK8中的effectively final</title>
    <link href="http://www.liutianhe.com/blog/effectively-final-JDK-8/"/>
    <id>http://www.liutianhe.com/blog/effectively-final-JDK-8/</id>
    <published>2017-04-23T08:27:44.000Z</published>
    <updated>2017-04-23T09:09:14.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>However, starting in Java SE 8, a local class can access local variables and parameters of the enclosing block that are final or effectively final. A variable or parameter whose value is never changed after it is initialized is effectively final.<br><a href="https://docs.oracle.com/javase/tutorial/java/javaOO/localclasses.html" target="_blank" rel="noopener">https://docs.oracle.com/javase/tutorial/java/javaOO/localclasses.html</a></p></blockquote><p>简单来说，如果只读一个外部变量，不再需要指定成final了。<br>而在之前，常见的匿名内部类访问外部局部变量必须指定成final。</p><p>下面这段代码1.8就可以执行，1.7就会编译报错。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> aa = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> bb = <span class="number">20</span>;</span><br><span class="line">    Thread t1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(aa+bb); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><pre><code>1.7报错内容：Error:(22, 36) java: 从内部类中访问本地变量aa; 需要被声明为最终类型</code></pre><p>当你要修改的外部变量时，在1.8下也会直接报错：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> aa = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> bb = <span class="number">20</span>;</span><br><span class="line">    Thread t1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(aa+bb);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    Thread t2 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            aa = <span class="number">20</span>; <span class="comment">//Error</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><pre><code>1.8报错内容Error:(34, 17) java: 从内部类引用的本地变量必须是最终变量或实际上的最终变量(needs to be final or effectively final)</code></pre>]]></content>
    
    <summary type="html">
    
      根据JDK8中的effectively final,闭包中访问外部变量不再必须指定为final
    
    </summary>
    
    
      <category term="java" scheme="http://www.liutianhe.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>在Spring中使用Junit4测试时访问JNDI资源</title>
    <link href="http://www.liutianhe.com/blog/junit-jndi-Spring/"/>
    <id>http://www.liutianhe.com/blog/junit-jndi-Spring/</id>
    <published>2017-03-23T10:41:16.000Z</published>
    <updated>2017-03-23T13:13:37.000Z</updated>
    
    <content type="html"><![CDATA[<p>系统使用JNDI来访问在容器上配置的资源信息（例如数据库信息）,如果用xml来配置的话一般这么写</p> <jee:jndi-lookup id="dataSource" jndi-name="jdbc/database" expected-type="javax.sql.DataSource"><p>但是使用Junit来做测试的时候并不会访问容器，也就无法获取资源信息。这个时候你可以另外写一份applicationContextTest.xml来供测试用，或者可以在Junit里配置JNDI资源。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@ContextConfiguration</span>(locations = <span class="string">"classpath:applicationContext.xml"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XXXXXXTest</span> </span>&#123; </span><br><span class="line">    <span class="meta">@BeforeClass</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setUpJndi</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException, NamingException</span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//配置DataSource</span></span><br><span class="line">        SybDataSource ds = <span class="keyword">new</span> SybDataSource();</span><br><span class="line">        ds.setServerName(<span class="string">"127.0.0.1"</span>);</span><br><span class="line">        ds.setPortNumber(<span class="number">5000</span>);</span><br><span class="line">        ds.setDatabaseName(<span class="string">"databaseName"</span>);</span><br><span class="line">        ds.setNetworkProtocol(<span class="string">"Tds"</span>);</span><br><span class="line">        ds.setUser(<span class="string">"user"</span>);</span><br><span class="line">        ds.setPassword(<span class="string">"password"</span>);</span><br><span class="line">        ds.setCHARSET(<span class="string">"cp936"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//配置ActiveMQ</span></span><br><span class="line">        ActiveMQTopic topic = <span class="keyword">new</span> ActiveMQTopic(<span class="string">"testTopic"</span>);</span><br><span class="line">        ActiveMQConnectionFactory connectionFactory = <span class="keyword">new</span> ActiveMQConnectionFactory(<span class="string">"tcp://localhost:61616"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//org.springframework.mock.jndi.SimpleNamingContextBuilder </span></span><br><span class="line">        SimpleNamingContextBuilder builder = <span class="keyword">new</span> SimpleNamingContextBuilder();</span><br><span class="line">        builder.bind(<span class="string">"jdbc/database"</span>, ds);</span><br><span class="line">        builder.bind(<span class="string">"jms/topic"</span>, topic);</span><br><span class="line">        builder.bind(<span class="string">"jms/topicConnFactory"</span>, connectionFactory);</span><br><span class="line">        builder.activate();</span><br><span class="line">    &#125;     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实际使用的时候，直接使用生产的applicationContext很容易因为过于庞大而初始化过程缓慢，如果项目非常大还是应该单独写几个测试的applicationContext分模块来测试。</p></jee:jndi-lookup>]]></content>
    
    <summary type="html">
    
      在Spring中使用Junit4测试时JNDI资源的访问问题
    
    </summary>
    
    
      <category term="Spring" scheme="http://www.liutianhe.com/tags/Spring/"/>
    
      <category term="Junit4" scheme="http://www.liutianhe.com/tags/Junit4/"/>
    
      <category term="JNDI" scheme="http://www.liutianhe.com/tags/JNDI/"/>
    
  </entry>
  
  <entry>
    <title>Spring+Maven+H2（Jave配置,非Spring Boot）</title>
    <link href="http://www.liutianhe.com/blog/spring-h2/"/>
    <id>http://www.liutianhe.com/blog/spring-h2/</id>
    <published>2017-02-13T12:35:23.000Z</published>
    <updated>2017-03-23T12:05:08.000Z</updated>
    
    <content type="html"><![CDATA[<p>H2作为一款嵌入式数据库非常适合用来写一些Demo小程序之类的。</p><p>首先配置pom.xml添加H2的依赖。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.h2database<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>h2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.193<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>接下来在你的RootConfig里配置数据源</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    EmbeddedDatabaseBuilder builder = <span class="keyword">new</span> EmbeddedDatabaseBuilder();</span><br><span class="line">    EmbeddedDatabase db = builder</span><br><span class="line">            .setType(EmbeddedDatabaseType.H2)</span><br><span class="line">            .addScript(<span class="string">"db/create-db.sql"</span>)</span><br><span class="line">            .addScript(<span class="string">"db/data-db.sql"</span>)</span><br><span class="line">            .build();</span><br><span class="line">    <span class="keyword">return</span> db;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>addScript的两个脚本是用来建表和添加测试数据的，期间发现org.h2.command.Parser解析create table语句必须写在一行里，不支持中间有换行符，按理说应该能如何配置下来支持。</p><p>想要开启H2的console还需要添加：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span>(initMethod=<span class="string">"start"</span>,destroyMethod=<span class="string">"stop"</span>)</span><br><span class="line"><span class="keyword">public</span> org.h2.tools.<span class="function">Server <span class="title">h2WebConsonleServer</span> <span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> org.h2.tools.Server.createWebServer(<span class="string">"-web"</span>,<span class="string">"-webAllowOthers"</span>,<span class="string">"-webDaemon"</span>,<span class="string">"-webPort"</span>, <span class="string">"8888"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>之后就可以通过localhost:8888访问H2的控制台了</p><p>够简单。</p>]]></content>
    
    <summary type="html">
    
      使用Java配置在Spring中使用H2数据库
    
    </summary>
    
    
      <category term="Spring" scheme="http://www.liutianhe.com/tags/Spring/"/>
    
      <category term="H2" scheme="http://www.liutianhe.com/tags/H2/"/>
    
  </entry>
  
  <entry>
    <title>升级hexo至3.2.2</title>
    <link href="http://www.liutianhe.com/blog/update-hexo-to-3-2-2/"/>
    <id>http://www.liutianhe.com/blog/update-hexo-to-3-2-2/</id>
    <published>2016-10-03T16:17:24.000Z</published>
    <updated>2016-10-03T17:26:19.000Z</updated>
    
    <content type="html"><![CDATA[<p>因为Win10的自动更新把系统彻底搞崩了，重装之后需要恢复hexo环境，正好借机将原来的2.X版本升级到最新版3.2.2，记录下过程以及中间遇到的问题：</p><h2 id="nodejs-amp-amp-git"><a href="#nodejs-amp-amp-git" class="headerlink" title="nodejs&amp;&amp;git"></a>nodejs&amp;&amp;git</h2><p>没什么好说的从官网下载最新版安装即可</p><h2 id="安装hexo"><a href="#安装hexo" class="headerlink" title="安装hexo"></a>安装hexo</h2><p><code>npm install -g hexo-cli</code></p><p>新版的hexo把很多部分拆出来模块化了，还需要单独安装，主要需要后安装server和git部署模块<br><code>npm install hexo-server --save</code><br><code>npm install hexo-deployer-git --save</code></p><h2 id="文件迁移"><a href="#文件迁移" class="headerlink" title="文件迁移"></a>文件迁移</h2><p>我选择新init了一个目录来做迁移，init之后比照着修改<code>_config.yml</code>，之后将原来的source_posts下的md文件全部复制过来，以及themes\metro-light经过我细微修改的metro-light主题目录</p><h2 id="生成"><a href="#生成" class="headerlink" title="生成"></a>生成</h2><p>然后hexo g生成测试下，报错了。。</p><pre><code>INFO  Start processingFATAL Something&apos;s wrong. Maybe you can find the solution here: http://hexo.io/docs/troubleshooting.htmlTemplate render error: (unknown path) [Line 7, Column 23]  Error: Unable to call `the return value of (posts[&quot;first&quot;])[&quot;updated&quot;][&quot;toISOString&quot;]`, which is undefined or falsey    at Object.exports.prettifyError (D:\OneDrive\blog\node_modules\hexo-generator-feed\node_modules\nunjucks\src\lib.js:34:15)    at D:\OneDrive\blog\node_modules\hexo-generator-feed\node_modules\nunjucks\src\environment.js:486:31    at root [as rootRenderFunc] (eval at &lt;anonymous&gt; (D:\OneDrive\blog\node_modules\hexo-generator-feed\node_modules\nunjucks\src\environment.js:565:24), &lt;anonymous&gt;:161:3)    at Obj.extend.render (D:\OneDrive\blog\node_modules\hexo-generator-feed\node_modules\nunjucks\src\environment.js:479:15)    at Hexo.module.exports (D:\OneDrive\blog\node_modules\hexo-generator-feed\lib\generator.js:28:22)    at Hexo.tryCatcher (D:\OneDrive\blog\node_modules\hexo\node_modules\bluebird\js\release\util.js:16:23)    at Hexo.&lt;anonymous&gt; (D:\OneDrive\blog\node_modules\hexo\node_modules\bluebird\js\release\method.js:15:34)    at D:\OneDrive\blog\node_modules\hexo\lib\hexo\index.js:337:24    at tryCatcher (D:\OneDrive\blog\node_modules\hexo\node_modules\bluebird\js\release\util.js:16:23)    at MappingPromiseArray._promiseFulfilled (D:\OneDrive\blog\node_modules\hexo\node_modules\bluebird\js\release\map.js:61:38)    at MappingPromiseArray.PromiseArray._iterate (D:\OneDrive\blog\node_modules\hexo\node_modules\bluebird\js\release\promise_array.js:113:31)    at MappingPromiseArray.init (D:\OneDrive\blog\node_modules\hexo\node_modules\bluebird\js\release\promise_array.js:77:10)    at MappingPromiseArray._asyncInit (D:\OneDrive\blog\node_modules\hexo\node_modules\bluebird\js\release\map.js:30:10)    at Async._drainQueue (D:\OneDrive\blog\node_modules\hexo\node_modules\bluebird\js\release\async.js:143:12)    at Async._drainQueues (D:\OneDrive\blog\node_modules\hexo\node_modules\bluebird\js\release\async.js:148:10)    at Immediate.Async.drainQueues [as _onImmediate] (D:\OneDrive\blog\node_modules\hexo\node_modules\bluebird\js\release\async.js:17:14)    at processImmediate [as _immediateCallback] (timers.js:383:17)FATAL (unknown path) [Line 7, Column 23]  Error: Unable to call `the return value of (posts[&quot;first&quot;])[&quot;updated&quot;][&quot;toISOString&quot;]`, which is undefined or falseyTemplate render error: (unknown path) [Line 7, Column 23]  Error: Unable to call `the return value of (posts[&quot;first&quot;])[&quot;updated&quot;][&quot;toISOString&quot;]`, which is undefined or falsey    at Object.exports.prettifyError (D:\OneDrive\blog\node_modules\hexo-generator-feed\node_modules\nunjucks\src\lib.js:34:15)    at D:\OneDrive\blog\node_modules\hexo-generator-feed\node_modules\nunjucks\src\environment.js:486:31    at root [as rootRenderFunc] (eval at &lt;anonymous&gt; (D:\OneDrive\blog\node_modules\hexo-generator-feed\node_modules\nunjucks\src\environment.js:565:24), &lt;anonymous&gt;:161:3)    at Obj.extend.render (D:\OneDrive\blog\node_modules\hexo-generator-feed\node_modules\nunjucks\src\environment.js:479:15)    at Hexo.module.exports (D:\OneDrive\blog\node_modules\hexo-generator-feed\lib\generator.js:28:22)    at Hexo.tryCatcher (D:\OneDrive\blog\node_modules\hexo\node_modules\bluebird\js\release\util.js:16:23)    at Hexo.&lt;anonymous&gt; (D:\OneDrive\blog\node_modules\hexo\node_modules\bluebird\js\release\method.js:15:34)    at D:\OneDrive\blog\node_modules\hexo\lib\hexo\index.js:337:24    at tryCatcher (D:\OneDrive\blog\node_modules\hexo\node_modules\bluebird\js\release\util.js:16:23)    at MappingPromiseArray._promiseFulfilled (D:\OneDrive\blog\node_modules\hexo\node_modules\bluebird\js\release\map.js:61:38)    at MappingPromiseArray.PromiseArray._iterate (D:\OneDrive\blog\node_modules\hexo\node_modules\bluebird\js\release\promise_array.js:113:31)    at MappingPromiseArray.init (D:\OneDrive\blog\node_modules\hexo\node_modules\bluebird\js\release\promise_array.js:77:10)    at MappingPromiseArray._asyncInit (D:\OneDrive\blog\node_modules\hexo\node_modules\bluebird\js\release\map.js:30:10)    at Async._drainQueue (D:\OneDrive\blog\node_modules\hexo\node_modules\bluebird\js\release\async.js:143:12)    at Async._drainQueues (D:\OneDrive\blog\node_modules\hexo\node_modules\bluebird\js\release\async.js:148:10)    at Immediate.Async.drainQueues [as _onImmediate] (D:\OneDrive\blog\node_modules\hexo\node_modules\bluebird\js\release\async.js:17:14)    at processImmediate [as _immediateCallback] (timers.js:383:17)</code></pre><p>看了眼似乎是hexo-generator-feed插件的问题<br>_config.yml：</p><pre><code>plugins:##- hexo-generator-feed</code></pre><p>注释掉这个插件后能够顺利生成了<br>看这个插件的Github上的issue目测是还没支持3.2.2（后面发现不是这个问题）<br><a href="https://github.com/hexojs/hexo-generator-feed/issues/43" target="_blank" rel="noopener">https://github.com/hexojs/hexo-generator-feed/issues/43</a><br>P.S.新版本的生成过程中输出信息少了很多，一度以为有问题，new了个新文章发现也是这样。</p><h2 id="本地测试"><a href="#本地测试" class="headerlink" title="本地测试"></a>本地测试</h2><p>之后准备运行server来本地先看看效果。结果hexo server说没有这个命令。。顿时迷茫了。。尝试重装了hexo和hexo-server依然不行，各种研究之后看到一个说是因为配置文件里的plugins项，看了眼hexo 3.0的改动日志。</p><pre><code>Plugin Loading MechanismIn Hexo 3, only plugins listed in package.json will be loaded, and plugins/scripts will be executed in sandbox so hexo namespace will be no longer exposed to global.</code></pre><p>这样看来_config.yml中的plugins项就失去了意义直接删除之后就可以顺利运行，连上面注释掉的feed插件也正常了。比照了下网站上的内容，发现没什么问题，进入下一步部署相关内容。</p><h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><p>先在Git Bash里生成ssh密钥<br><code>ssh-keygen -t rsa -b 4096 -C &quot;your_email@example.com&quot;</code><br>将公钥配置到Github和Coding.net中（我是同时部署到这两个网站，在dnspod里配置DNS信息，联通和电信访问Coding.net其他就访问Github）<br>再<br><code>ssh -T git@github.com</code><br><code>ssh -T git@git.coding.net</code><br>测试下连通性，第一次的话一般会提示:</p><pre><code>The authenticity of host &apos;github.com (192.30.253.113)&apos; can&apos;t be established.RSA key fingerprint is SHA256:nThbg6kXUpJWGl7E1IGOCspRomTxdCARLviKw6E5SY8.Are you sure you want to continue connecting (yes/no)? yesWarning: Permanently added &apos;github.com,192.30.253.113&apos; (RSA) to the list of known hosts.Hi XXXXXXX! You&apos;ve successfully authenticated, but GitHub does not provide shell access.</code></pre><p>将网站的公钥加入到known_hosts中。</p>]]></content>
    
    <summary type="html">
    
      记录下重装系统后将hexo升级到3.2.2版本的过程以及遇到的问题
    
    </summary>
    
    
      <category term="hexo" scheme="http://www.liutianhe.com/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>sql中join on和join using的异同</title>
    <link href="http://www.liutianhe.com/blog/sql-join-on-using/"/>
    <id>http://www.liutianhe.com/blog/sql-join-on-using/</id>
    <published>2016-09-27T13:04:17.000Z</published>
    <updated>2016-09-27T14:22:33.000Z</updated>
    
    <content type="html"><![CDATA[<p>使用join on和join using的目的都是通过某个列连接在一起，但是有以下不同点：</p><ul><li>on可以通过表达式来连接不同名称的列，例如<code>on (tableA.columnA = tableB.columnB)</code>,而using必须是同名列。</li><li>返回的结果集不一样：看下图：<br><img src="http://oe59i0jvi.bkt.clouddn.com/sql-join-on-using-1.png" alt="结果演示"><br>可以看到用on的时候相当于把两个表的连接那列都返回回来，而using只返回了一列，并且这一列在select中是可以没有表名来限定的。<br>P.S.查资料看有些数据库(oracle?)的话这一列是不能有表名限定的，在我本地的MySQL是都可以的。<br><img src="http://oe59i0jvi.bkt.clouddn.com/sql-join-on-using-2.png" alt="列限定名"></li></ul>]]></content>
    
    <summary type="html">
    
      sql中连接(join)语句使用on或者using关键字来指定连接的列时的异同
    
    </summary>
    
    
      <category term="sql" scheme="http://www.liutianhe.com/tags/sql/"/>
    
  </entry>
  
  <entry>
    <title>Apache CXF部署到WebSphere Application Server</title>
    <link href="http://www.liutianhe.com/blog/ApacheCXF_on_WebSphere/"/>
    <id>http://www.liutianhe.com/blog/ApacheCXF_on_WebSphere/</id>
    <published>2016-08-09T10:54:09.000Z</published>
    <updated>2016-08-18T13:42:52.000Z</updated>
    
    <content type="html"><![CDATA[<p>在开发过程中CXF是部署的本地的Tomcat上的，开发完并用SoapUI简单测试过之后开始准备部署到测试环境上，测试环境是使用的WebSphere Application Server 8.0.0.5版本。<br>部署上去后访问wsdl页面报error500，JVMVRFY013错误，头一次看到JVM错误。。。</p><p>首先看了ApacheCXF官网的文章：<br><a href="http://cxf.apache.org/docs/application-server-specific-configuration-guide.html#ApplicationServerSpecificConfigurationGuide-ForWebSphere6.1.0.29+,V7andV8" target="_blank" rel="noopener">application-server-specific-configuration-guide.html#ApplicationServerSpecificConfigurationGuide-ForWebSphere6.1.0.29+,V7andV8</a><br>以及IBM的文档：<br><a href="http://public.dhe.ibm.com/software/dw/wes/1001_thaker/1001_thaker.pdf" target="_blank" rel="noopener">1001_thaker.pdf</a>。</p><p>1.参照里面说的确认Class loader设置成了<code>Classes loaded with local class loader first(parent last)</code>。<br>2.设置JVM参数<code>-Dcom.ibm.websphere.webservices.DisableIBMJAXWSEngine=true</code>（或者修改war包里的<code>WebContent/META-INF/MANIFEST.MF</code>添加<code>DisableIBMJAXWSEngine:true</code>）来禁用了IBM JAX-WS implementation。</p><p>修改完之后依然same error…<br>于是乎想着更换下CXF的版本从2.3.9换成2.7.18（因为要注册到ESB上，一开始给我们的推荐版本就是2.3.9没敢直接换到3.X.X），突然间，奇迹发生了，wsdl页面能正常显示出来了，可惜高兴没多久就发现调用服务的时候依然会报错same error。。。。</p><p>最后。。再一次。。被Stackoverflow拯救了</p><pre><code>then deleting from our deploy the following jar:    activation-*,    stax-api-* (but not stax2-api!),    jaxb-api-*,    jaxb-impl-*,    xercesImpl-*,    xml-apis-*</code></pre><p>发现项目中包含了activation.1.1.1.jar(其实并不知道这个jar包是干什么的。。),删了之后发现一切正常了！</p>]]></content>
    
    <summary type="html">
    
      在WebSphere上部署Apache CXF实现的Web Service服务注意事项。
    
    </summary>
    
    
      <category term="Web Service" scheme="http://www.liutianhe.com/tags/Web-Service/"/>
    
      <category term="CXF" scheme="http://www.liutianhe.com/tags/CXF/"/>
    
      <category term="WebSphere" scheme="http://www.liutianhe.com/tags/WebSphere/"/>
    
  </entry>
  
  <entry>
    <title>记解决引入CXF的jar包导致异常情况的过程及所学知识</title>
    <link href="http://www.liutianhe.com/blog/Apache-CXF-override-Provider/"/>
    <id>http://www.liutianhe.com/blog/Apache-CXF-override-Provider/</id>
    <published>2016-07-08T10:56:23.000Z</published>
    <updated>2016-08-18T13:44:23.000Z</updated>
    
    <content type="html"><![CDATA[<p>为了在一个已有系统中实现对外提供Web Service，并在ESB中注册，使用Apache CXF来实现提供服务的功能。在项目中引入了CXF及其依赖的JAR包并修改web.xml和spring的applicationcontext.xml（CXF和Spring集成的真好）之后，发现原有的调用其它Web Service返回的结果中文出现乱码，并且报文头出现了一些区别。逐步排查发现只要引入JAR包就会出现这个问题，于是乎开始深入研究调用Web Service调用过程来定位问题所在。</p><p>调用Web Service服务需要WSDL文件以及根据这个WSDL文件生成的jar包,jar包里除了对外暴露的接口类之外，还有一个继承javax.xml.ws.Service的类和一个包含所有可调用方法的接口类。在使用时通过Class.forName(Service的子类)，并通过<code>getConstructor(URL.class, Qname.class).newInstance(XX,XX)</code>来实例化一个Service类，再通过getPort来获取接口的代理类,进而再调用具体的方法。</p><p>在对比分析之后，发现引入CXF包的前后，Service类中的delegate的具体实现类发生了变化。开始怀疑是因为引入的CXF的JAR包通过某种方式覆盖了默认的实现类。</p><p>最后还是借助了伟大的面向Stackoverflow编程大法:<a href="http://stackoverflow.com/questions/6364333/jax-ws-when-apache-cxf-is-installed-it-steals-default-jdk-jax-ws-implementat" target="_blank" rel="noopener">JAX-WS = When Apache CXF is installed it “steals” default JDK JAX-WS implementation</a></p><h2 id="引用下大牛答案"><a href="#引用下大牛答案" class="headerlink" title="引用下大牛答案:"></a>引用下大牛答案:</h2><p>Apache CXF (<code>cxf-rt-frontend-jaxws-\*.jar</code> to be precise) registers itself as a JAX-WS provider in the JVM.<br>Inside the aforementioned JAR there is a file named: <code>/META-INF/services/javax.xml.ws.spi.Provider</code> with the following contents:<br><code>org.apache.cxf.jaxws.spi.ProviderImpl</code><br>If you now look at javax.xml.ws.spi.FactoryFinder#find method you will discover that JDK searches the CLASSPATH for the presence of javax.xml.ws.spi.Provider file and falls back to default Sun implementation if not available. So you have two options to force fallback:</p><ul><li>either remove <code>cxf-rt-frontend-jaxws-\*.jar</code> from CLASSPATH</li><li>or override <code>javax.xml.ws.spi.Provider</code> file provided by CXF to point to fallback location</li></ul><p>The second option is actually a bit easier. Simply create:<br><code>/src/main/resources/META-INF/services/javax.xml.ws.spi.Provider</code><br>file (assuming you are using Maven) with the following contents:<br><code>org.apache.cxf.jaxws.spi.ProviderImpl</code><br>That’s it, tested with <code>javax.xml.ws.Endpoint#publish</code>.</p><hr><p>在CXF的jar包中有这么个文件<code>/META-INF/services/javax.xml.ws.spi.Provider</code>(文件名就是javax.xml.ws.spi.Provider)，内容只有一行<code>org.apache.cxf.jaxws.spi.ProviderImpl</code>。<br>这个时候就涉及到了<strong>JAVA SPI(Service Provider Interface)</strong>技术，简单来说就是通过配置文件来动态指定实现类。<br>这篇博客写的非常浅显易懂:<a href="http://ivanzhangwb.github.io/blog/2012/06/01/java-spi/" target="_blank" rel="noopener">Java SPI机制简介</a></p><p>在删除了CXF的JAR包中的javax.xml.ws.spi.Provider文件之后就一切恢复了正常，但是这并没有很好的解决问题，删除之后使用默认的Provider对CXF的功能有什么影响还有待测试，但起码定位了问题，后续继续研究学习！</p>]]></content>
    
    <summary type="html">
    
      在一个老系统中引入了CXF来实现Web Service服务端对外提供服务,却导致了系统原有的调用其他Web Service出现异常。
    
    </summary>
    
    
      <category term="JAVA" scheme="http://www.liutianhe.com/tags/JAVA/"/>
    
      <category term="Web Service" scheme="http://www.liutianhe.com/tags/Web-Service/"/>
    
      <category term="CXF" scheme="http://www.liutianhe.com/tags/CXF/"/>
    
      <category term="SPI(Service Provider Interface)" scheme="http://www.liutianhe.com/tags/SPI-Service-Provider-Interface/"/>
    
  </entry>
  
  <entry>
    <title>加权随机算法</title>
    <link href="http://www.liutianhe.com/blog/Weighted%20Random%20Distribution/"/>
    <id>http://www.liutianhe.com/blog/Weighted Random Distribution/</id>
    <published>2015-03-31T15:04:59.000Z</published>
    <updated>2015-06-26T14:25:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>加权随机算法一般应用在以下场景：有一个集合S，里面比如有A,B,C,D这四项。这时我们想随机从中抽取一项，但是抽取的概率不同，比如我们希望抽到A的概率是50%,抽到B和C的概率是20%,D的概率是10%。一般来说，我们可以给各项附一个权重，抽取的概率正比于这个权重。那么上述集合就成了：</p><p>{A:5，B:2，C:2，D:1}</p><p>###方法一：</p><p>扩展这个集合，使每一项出现的次数与其权重正相关。在上述例子这个集合扩展成：<br>{A,A,A,A,A,B,B,C,C,D}<br>然后就可以用均匀随机算法来从中选取。</p><p><strong>好处</strong>：选取的时间复杂度为O（1）,算法简单。<br><strong>坏处</strong>：空间占用极大。另外如果权重数字位数较大，例如{A:49.1 B：50.9}的时候，就会产生巨大的空间浪费。</p><p>###方法二：</p><p>计算权重总和sum，然后在1到sum之间随机选择一个数R，之后遍历整个集合，统计遍历的项的权重之和，如果大于等于R，就停止遍历，选择遇到的项。</p><p>还是以上面的集合为例，sum等于10，如果随机到1-5，则会在遍历第一个数字的时候就退出遍历。符合所选取的概率。</p><p><strong>好处</strong>：没有额外的空间占用，算法也比较简单。<br><strong>坏处</strong>：选取的时候要遍历集合，时间复杂度是O（n）。  </p><p>###方法三：</p><p>可以对方法二进行优化，对项目集按照权重排序。这样遍历的时候，概率高的项可以很快遇到，减少遍历的项。<br>比较{A:5，B:2，C:2，D:1}和{B:2，C:2，A:5，D:1}<br>前者遍历步数的期望是5/10*1+2/10*2+2/10*3+1/10*4而后者是2/10*1+2/10*2+5/10*3+1/10*4。</p><p><strong>好处</strong>：提高了平均选取速度。<br><strong>坏处</strong>：需要进行排序，并且不易添加删除修改项。  </p>]]></content>
    
    <summary type="html">
    
      介绍几种常用的加权随机算法以及各自的优缺点
    
    </summary>
    
    
      <category term="algorithm" scheme="http://www.liutianhe.com/tags/algorithm/"/>
    
  </entry>
  
  <entry>
    <title>个人理财-基金</title>
    <link href="http://www.liutianhe.com/blog/finance-fund/"/>
    <id>http://www.liutianhe.com/blog/finance-fund/</id>
    <published>2015-01-10T08:39:50.000Z</published>
    <updated>2015-05-30T11:05:47.000Z</updated>
    
    <content type="html"><![CDATA[<p>马上就要走向工作了，趁着还有时间，研究一下个人理财，为将来的资产增值做好准备！（其实就是工资太低。。。）<br>P.S.可能有不准确的地方。</p><p>#基金</p><p>一些基本的名词解释：  </p><p><strong>一级市场</strong>：就是公司发行股票，对个人来说一般申购新股（打新）也就是在一级市场买股票。<br><strong>二级市场</strong>：也就是在交易所中买卖，也就是个人和个人之间交易股票。（个人也泛指机构一类）<br><strong>场内场外</strong>：场内就是只交易所内，买卖需要在证券公司开户，场外则是可以通过银行或者在线购买产品。<br><strong>未知价格交易法</strong>：场外的基金申购和赎回时都是不确定净值的，当日15点之前的交易按照当天的净值计算，15点之后的按照第二天的净值计算。<br><strong>基金净值更新时间</strong>: </p><ol><li>ETF基金净值是随时更新  </li><li>LOF基金,每天更新5次.9:30 10:30 11:30 2:00 3:00点的净值是晚上出来 </li><li>普通开放基金每天一次(一般是晚上18点以后)</li><li>封闭基金每周更新一次</li></ol><p>##股票基金</p><p>股票基金顾名思义就是以投资股票为主，根据选择股票的方向可以按行业，主题等划分。</p><p>##债券基金</p><p>债券基金是以投资债券为主，普通债券基金风险很低，但是仍然是会亏损的。</p><p>##可转换债券</p><p>可转换债券是债券的一种，利率低但是可以转换成公司股票，当股市很好的时候很多可转换债券基金收益比股票基金的收益都高。</p><p>##分级基金</p><p>分级基金一般来说是将母基金分成子基金A和子基金B，一般子基金A会获得一个比较稳定的收益，当母基金获益时，满足A的稳定收益之后，其他收益都归B所有，也就是收益增加B会获得更高的收益，而当母基金亏损时，会满足A的收益，加大B的亏损。这样通过杠杆，使两只子基金一只低风险低收益，一只高风险高收益。</p><p>##ETF</p><p>交易型开放式指数基金，通常又被称为交易所交易基金（Exchange Traded Funds，简称“ETF”）<br>ETF的最大特点是在场内交易，但有一些场外基金与ETF进行联接。<br>A股有两只300ETF:510300,159919。</p><p>##LOF</p><p>LOF基金，英文全称是”Listed Open-Ended Fund”，汉语称为”上市型开放式基金”。LOF是在场内场外都能进行交易的基金，一些分级基金在运作期满之后会转换成LOF基金。</p>]]></content>
    
    <summary type="html">
    
      马上就要走向工作了，趁着还有时间，研究一下个人理财，为将来的资产增值做好准备！（其实就是工资太低。。。）P.S.可能有不准确的地方。
    
    </summary>
    
    
      <category term="理财" scheme="http://www.liutianhe.com/tags/%E7%90%86%E8%B4%A2/"/>
    
  </entry>
  
  <entry>
    <title>双基准快速排序 Dual-Pivot Quicksort</title>
    <link href="http://www.liutianhe.com/blog/Dual-Pivot_Quicksort/"/>
    <id>http://www.liutianhe.com/blog/Dual-Pivot_Quicksort/</id>
    <published>2014-08-31T09:09:09.000Z</published>
    <updated>2018-04-05T06:44:40.190Z</updated>
    
    <content type="html"><![CDATA[<p>课本上常见的快速排序都是选择一个枢纽元（Pivot），基于这个枢纽元从前后双向扫描分成大于枢纽元和小于枢纽元的。而从JDK 7开始，java.util.Arrays.sort()使用双基准快速排序（Dual-Pivot Quicksort）作为实现。</p><p>—update JDK7使用双基准快速排序来排序基本元素，针对对象用TimSort<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public static void sort(int[] a) &#123;</span><br><span class="line">    DualPivotQuicksort.sort(a, 0, a.length - 1, null, 0, 0); </span><br><span class="line">&#125;</span><br><span class="line">public static void sort(Object[] a) &#123;</span><br><span class="line">    if (LegacyMergeSort.userRequested) //java -Djava.util.Arrays.useLegacyMergeSort=true 这个是运行时配置的</span><br><span class="line">        legacyMergeSort(a);</span><br><span class="line">    else</span><br><span class="line">        ComparableTimSort.sort(a, 0, a.length, null, 0, 0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="传统快速排序："><a href="#传统快速排序：" class="headerlink" title="传统快速排序："></a>传统快速排序：</h3><ol><li>选择枢纽元pivot,有很多种选法，但都只有一个。</li><li>基于枢纽元分成大于和小于的两部分，并且枢纽元放到最终的位置。</li><li>递归排序大于和小于的两部分。</li></ol><h3 id="双基准快速排序："><a href="#双基准快速排序：" class="headerlink" title="双基准快速排序："></a>双基准快速排序：</h3><ol><li>对于长度小于17的数组使用插入排序(常见优化步骤，传统快排也有应用)。</li><li>选择两个枢纽元p1,p2，一般选择起始元素a[left]和末尾元素a[right]（有其他选取方式）。</li><li>假设p1&lt;p2，如果不是就交换。</li><li>基于这p1,p2将整个数组分成三部分，&lt;p1的,p1&lt;&amp;&lt;p2的,&gt;p2的。</li><li>递归排序这三个部分。</li></ol><p>其中4这个步骤是采用单向扫描，leetcode上的Sort Colors这题一般就是采用同样的方法分成三部分。<br><a href="https://oj.leetcode.com/problems/sort-colors/" target="_blank" rel="noopener">https://oj.leetcode.com/problems/sort-colors/</a></p><p>详细的可以参考下面论文，里面有详细的细节以及算法实现。   </p><p>###Reference：</p><p><a href="http://iaroslavski.narod.ru/quicksort/DualPivotQuicksort.pdf" target="_blank" rel="noopener">DualPivotQuicksort.pdf</a></p>]]></content>
    
    <summary type="html">
    
      课本上常见的快速排序都是选择一个枢纽元（Pivot），基于这个枢纽元从前后双向扫描分成大于枢纽元和小于枢纽元的。而从JDK 7开始，java.util.Arrays.sort()使用双基准快速排序（Dual-Pivot Quicksort）作为实现。
    
    </summary>
    
    
      <category term="algorithm" scheme="http://www.liutianhe.com/tags/algorithm/"/>
    
  </entry>
  
  <entry>
    <title>限定ASP.NET Web API返回对象的Content-Type为application/json</title>
    <link href="http://www.liutianhe.com/blog/fix_content-type_to_Applicationjson_in_WebApi/"/>
    <id>http://www.liutianhe.com/blog/fix_content-type_to_Applicationjson_in_WebApi/</id>
    <published>2014-08-25T11:36:36.000Z</published>
    <updated>2014-08-31T09:17:19.000Z</updated>
    
    <content type="html"><![CDATA[<p>ASP.NET WebAPI是一套RESTful API开发框架。会自动序列化返回的对象成XML或JSON,其序列化后的格式取决于Request的header中的Accept。常见的有：</p><ul><li>application/json</li><li>application/xml</li><li>text/json</li><li>text/xml(这两种已经被废弃了）</li></ul><p>如果不指定的话默认返回的Content-Type是：application/json; charset=utf-8</p><p>所以使用Chrome和IE11来Get Web Api返回的格式就不同，Chrome是application/xml，而IE11是application/json，就因为两个浏览器请求的Header中的Accept字段不一样。<br>Chrome：<br><code>Accept:text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</code><br>IE11:<br><code>Accept:text/html, application/xhtml+xml, */*</code><br>区别就在于Chrome多了一个<strong>application/xml</strong>。</p><p>###想要指定格式，有两种方法：<br><strong>方法一是放弃自动序列化</strong>，选择返回HttpResponseMessage，再手动设置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HttpResponseMessage resp = new HttpResponseMessage();</span><br><span class="line">resp.Content = new StringContent(jsoncontent, System.Text.Encoding.UTF8, &quot;application/json&quot;);</span><br></pre></td></tr></table></figure><p>但是这样就失去了自动序列化带来的便捷，以及导致生成Web API Help Page无法捕获返回的对象。<br>（这也是我为什么要研究这个的原因。。。。结果后来发现可以用<code>[ResponseType(typeof(List&lt;PushPin&gt;))]</code>来指定实际返回的对象）   </p><p><strong>方法二就是设置HttpConfiguration</strong>，设置成只支持application/json。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public static class WebApiConfig</span><br><span class="line">&#123;</span><br><span class="line">  public static void Register()</span><br><span class="line">  &#123;</span><br><span class="line">    // Use this class to set configuration options for your mobile service</span><br><span class="line">    ConfigOptions options = new ConfigOptions();</span><br><span class="line">    // Use this class to set WebAPI configuration options</span><br><span class="line">    HttpConfiguration config = ServiceConfig.Initialize(new ConfigBuilder(options));</span><br><span class="line">    config.Formatters.XmlFormatter.SupportedMediaTypes.Clear(); </span><br><span class="line">    var appjsonType = config.Formatters.JsonFormatter.SupportedMediaTypes.FirstOrDefault(t =&gt; t.MediaType == &quot;text/json&quot;);</span><br><span class="line">    config.Formatters.JsonFormatter.SupportedMediaTypes.Remove(appjsonType);</span><br><span class="line">    // To display errors in the browser during development, uncomment the following</span><br><span class="line">    // line. Comment it out again when you deploy your service for production use.</span><br><span class="line">    // config.IncludeErrorDetailPolicy = IncludeErrorDetailPolicy.Always;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>关键是这几句：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//删除所有的xml格式，也就是text/xml,application/xml</span><br><span class="line">config.Formatters.XmlFormatter.SupportedMediaTypes.Clear();   </span><br><span class="line">//删除text/json  </span><br><span class="line">var appjsonType=config.Formatters.JsonFormatter.SupportedMediaTypes.FirstOrDefault(t =&gt; t.MediaType == &quot;text/json&quot;);</span><br><span class="line">config.Formatters.JsonFormatter.SupportedMediaTypes.Remove(appjsonType);</span><br></pre></td></tr></table></figure><p>其实就是使Web API不支持其他格式了。但是这种方法有个弊端，是全局的，但是应该可以限定范围，暂时先不管了。</p><p>P.S.吐槽下，IE默认是不显示JSON的，会直接下载下来，所以开发人员工具就捕获不到HTTP报文，也没法看Header。找了个方法解决之：</p><pre><code>为了测试更方便，一般我使用 Web API 都会设置让 Web API 返回 Json 格式。在IE浏览器中，当伙同在地址输入 URL 后 IE 浏览器会弹出是否需要下载的提示。实际上 IE 弹出下载提示也没有什么不好的，但是有时候想要迫不及待的看到Json返回的结果时，又需要反复的下载再打开查看，这个行为就显得让人讨厌了。如果能够像 Chrome 或 Firefox 可直接看结果就好了。解决办法也非常简单，需要我们在操作系统的注册表中添加关于 JSON 的 MIME 类型支持，你可以将以下内容编辑成扩展名为 .reg 的文件（文件名随意），然后双击执行将该文件导入注册表：Windows Registry Editor Version 5.00[HKEY_CLASSES_ROOT\MIME\Database\Content Type\application/json]&quot;CLSID&quot;=&quot;{25336920-03F9-11cf-8FD0-00AA00686F13}&quot;&quot;Encoding&quot;=dword:00080000[HKEY_CLASSES_ROOT\MIME\Database\Content Type\text/json]&quot;CLSID&quot;=&quot;{25336920-03F9-11cf-8FD0-00AA00686F13}&quot;&quot;encoding&quot;=dword:00080000其原理是修改注册表，将 application/json、text/json 两种 Content-Type 开启设置调成与 GIF/PNG/HTML 一致，改为直接用浏览器打开查看。导入上面的注册表文件以后，再使用IE开启就可以不需要下载即可显示 json 了。</code></pre><p>From <a href="http://www.iefans.net/ie-dakai-json-xianshi/" target="_blank" rel="noopener">http://www.iefans.net/ie-dakai-json-xianshi/</a></p>]]></content>
    
    <summary type="html">
    
      ASP.NET Web API是一套RESTful API开发框架。会自动序列化返回的对象成XML或JSON,其序列化后的格式取决于Request的header：Accept。但是某些情况需要固定返回对象的格式为JSON或XML之一，本文介绍了两种方法。
    
    </summary>
    
    
      <category term="Web API" scheme="http://www.liutianhe.com/tags/Web-API/"/>
    
  </entry>
  
  <entry>
    <title>Consistent Hashing一致性哈希库libconhash的使用与实现</title>
    <link href="http://www.liutianhe.com/blog/Consistent_Hashing_libconhash/"/>
    <id>http://www.liutianhe.com/blog/Consistent_Hashing_libconhash/</id>
    <published>2014-08-06T15:04:59.000Z</published>
    <updated>2014-08-29T13:27:10.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>闲着没事看了看一致性哈希，找了个开源库libconhash看看如何实现。</strong><br><strong>整过过程非常清晰，代码也非常易懂，注释也非常全，带sample，简直就是开源库的典范！！</strong><br><a href="http://sourceforge.net/projects/libconhash/" target="_blank" rel="noopener">libconhash的sourceforge下载地址</a>  </p><p>From wikipedia    </p><blockquote><p><strong>一致哈希</strong> 是一种特殊的哈希算法。在使用一致哈希算法后，哈希表槽位数（大小）的改变平均只需要对K/n 个关键字重新映射，其中 K是关键字的数量，n是槽位数量。然而在传统的哈希表中，添加或删除一个槽位的几乎需要对所有关键字进行重新映射。<br><strong>需求</strong>:在使用n台缓存服务器时，一种常用的负载均衡方式是，对资源o的请求使用hash(o) = o mod n来映射到某一台缓存服务器。当增加或减少一台缓存服务器时这种方式可能会改变所有资源对应的hash值，也就是所有的缓存都失效了，这会使得缓存服务器大量集中地向原始内容服务器更新缓存。因些需要一致哈希算法来避免这样的问题。 一致哈希尽可能使同一个资源映射到同一台缓存服务器。这种方式要求增加一台缓存服务器时，新的服务器尽量分担存储其他所有服务器的缓存资源。减少一台缓存服务器时，其他所有服务器也可以尽量分担存储它的缓存资源。 一致哈希算法的主要思想是将每个缓存服务器与一个或多个哈希值域区间关联起来，其中区间边界通过计算缓存服务器对应的哈希值来决定。（定义区间的哈希函数不一定和计算缓存服务器哈希值的函数相同，但是两个函数的返回值的范围需要匹配。）如果一个缓存服务器被移除，则它会从对应的区间会被并入到邻近的区间，其他的缓存服务器不需要任何改变。<br><strong>实现</strong>:一致哈希将每个对象映射到圆环边上的一个点，系统再将可用的节点机器映射到圆环的不同位置。查找某个对象对应的机器时，需要用一致哈希算法计算得到对象对应圆环边上位置，沿着圆环边上查找直到遇到某个节点机器，这台机器即为对象应该保存的位置。 当删除一台节点机器时，这台机器上保存的所有对象都要移动到下一台机器。添加一台机器到圆环边上某个点时，这个点的下一台机器需要将这个节点前对应的对象移动到新机器上。 更改对象在节点机器上的分布可以通过调整节点机器的位置来实现。</p></blockquote><p>#使用方式<br>首先进行初始化<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">struct conhash_s *conhash = conhash_init(NULL);</span><br></pre></td></tr></table></figure></p><p>其中参数是个函数指针，指定将字符串转成long int的hash函数。默认hash函数的实现是:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> __conhash_hash_def(<span class="keyword">const</span> <span class="keyword">char</span> *instr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">long</span> hash = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> digest[<span class="number">16</span>];</span><br><span class="line">    conhash_md5_digest((<span class="keyword">const</span> u_char*)instr, digest);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* use successive 4-bytes from hash as numbers */</span></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        hash += ((<span class="keyword">long</span>)(digest[i*<span class="number">4</span> + <span class="number">3</span>]&amp;<span class="number">0xFF</span>) &lt;&lt; <span class="number">24</span>)</span><br><span class="line">            | ((<span class="keyword">long</span>)(digest[i*<span class="number">4</span> + <span class="number">2</span>]&amp;<span class="number">0xFF</span>) &lt;&lt; <span class="number">16</span>)</span><br><span class="line">            | ((<span class="keyword">long</span>)(digest[i*<span class="number">4</span> + <span class="number">1</span>]&amp;<span class="number">0xFF</span>) &lt;&lt;  <span class="number">8</span>)</span><br><span class="line">            | ((<span class="keyword">long</span>)(digest[i*<span class="number">4</span> + <span class="number">0</span>]&amp;<span class="number">0xFF</span>));</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">return</span> hash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">struct node_s g_nodes[64];</span><br></pre></td></tr></table></figure><p>node_s是标识节点的结构体，定义如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct node_s</span><br><span class="line">&#123;</span><br><span class="line">    char iden[64]; /* node name or some thing identifies the node */</span><br><span class="line">    u_int replicas; /* number of replica virtual nodes */</span><br><span class="line">    u_int flag;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>接下来是设置节点以及将添加节点：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/* set nodes */</span><br><span class="line">conhash_set_node(&amp;g_nodes[0], &quot;titanic&quot;, 32);</span><br><span class="line">/* add nodes */</span><br><span class="line">conhash_add_node(conhash, &amp;g_nodes[0]);</span><br></pre></td></tr></table></figure><p>其中<strong>titanic</strong>是这个节点的唯一标识符也就是node_s中的iden，一般可以用机器名或IP地址。而后面的<strong>32</strong>则代表这个节点对应的虚拟节点的数量replicas，一般来说一个节点的虚拟节点数占总的虚拟节点数的比重越大，那么分配到这个节点的条目也就越多。<br>flag是标识节点状态的，有<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define NODE_FLAG_INIT  0x01 /* node is initialized */</span><br><span class="line">#define NODE_FLAG_IN    0x02 /* node is added in the server */</span><br></pre></td></tr></table></figure></p><p>两种状态</p><p>删除节点与查询：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">conhash_del_node(conhash, &amp;g_nodes[0]);</span><br><span class="line">struct node_s node = conhash_lookup(conhash, str);</span><br></pre></td></tr></table></figure></p><p>释放资源：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conhash_fini(conhash);</span><br></pre></td></tr></table></figure></p><p>#内部实现原理</p><p>libconhash使用红黑树来保存虚拟节点。当一个节点插入后，生成所有的虚拟节点标识符字符串，并进行hash运算转成long之后插入到红黑树。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">//replicas是节点的虚拟节点数量</span><br><span class="line">for(i = 0; i &lt; node-&gt;replicas; i++)</span><br><span class="line">&#123;</span><br><span class="line">    //生成虚拟几点的标识符</span><br><span class="line">    __conhash_node2string(node, i, buff, &amp;len);</span><br><span class="line">    //计算标识符的hash，cb_hashfunc是初始化时制定的hash函数指针</span><br><span class="line">    hash = conhash-&gt;cb_hashfunc(buff);</span><br><span class="line">    //如果红黑树种没有存在的话就插入其中。</span><br><span class="line">    if(util_rbtree_search(&amp;(conhash-&gt;vnode_tree), hash) == NULL)</span><br><span class="line">    &#123;</span><br><span class="line">        //生成红黑树节点</span><br><span class="line">        rbnode = __conhash_get_rbnode(node, hash);</span><br><span class="line">        if(rbnode != NULL)</span><br><span class="line">        &#123;</span><br><span class="line">            //生成成功就插入到红黑树中</span><br><span class="line">            util_rbtree_insert(&amp;(conhash-&gt;vnode_tree), rbnode);</span><br><span class="line">            conhash-&gt;ivnodes++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中生成红黑树节点的代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">util_rbtree_node_t *__conhash_get_rbnode(struct node_s *node, long hash)</span><br><span class="line">&#123;</span><br><span class="line">    util_rbtree_node_t *rbnode;</span><br><span class="line">    rbnode = (util_rbtree_node_t *)malloc(sizeof(util_rbtree_node_t));</span><br><span class="line">    if(rbnode != NULL)</span><br><span class="line">    &#123;</span><br><span class="line">        rbnode-&gt;key = hash;</span><br><span class="line">        rbnode-&gt;data = malloc(sizeof(struct virtual_node_s));</span><br><span class="line">        if(rbnode-&gt;data != NULL)</span><br><span class="line">        &#123;</span><br><span class="line">            struct virtual_node_s *vnode = rbnode-&gt;data;</span><br><span class="line">            vnode-&gt;hash = hash;</span><br><span class="line">            vnode-&gt;node = node;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            free(rbnode);</span><br><span class="line">            rbnode = NULL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return rbnode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>virtual_node_s保存了hash值和实际节点的指针：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct virtual_node_s</span><br><span class="line">&#123;</span><br><span class="line">long hash;</span><br><span class="line">struct node_s *node; /* pointer to node */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>而删除节点就是将红黑树中的它的所有虚拟节点删除<br>其中虚拟节点标识符的生成规则是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_snprintf_s(buf, 127, _TRUNCATE, &quot;%s-%03d&quot;, node-&gt;iden, replica_idx);</span><br></pre></td></tr></table></figure></p><p>而查找的流程就是计算查找对象的hash然后查找红黑树中比他大的最小节点如果没有比他大的就选择最小的节点。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hash = conhash-&gt;cb_hashfunc(object);</span><br><span class="line">rbnode = util_rbtree_lookup(&amp;(conhash-&gt;vnode_tree), hash);</span><br><span class="line">if(rbnode != NULL)</span><br><span class="line">&#123;</span><br><span class="line">struct virtual_node_s *vnode = rbnode-&gt;data;</span><br><span class="line">return vnode-&gt;node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>红黑树的查找代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">if((rbtree != NULL) &amp;&amp; !util_rbtree_isempty(rbtree))</span><br><span class="line">&#123;</span><br><span class="line">util_rbtree_node_t *node = NULL;</span><br><span class="line">util_rbtree_node_t *temp = rbtree-&gt;root;</span><br><span class="line">util_rbtree_node_t *null = _NULL(rbtree);</span><br><span class="line">while(temp != null)</span><br><span class="line">&#123;</span><br><span class="line">if(key &lt;= temp-&gt;key)</span><br><span class="line">&#123;</span><br><span class="line">node = temp; /* update node */</span><br><span class="line">temp = temp-&gt;left;</span><br><span class="line">&#125;</span><br><span class="line">else if(key &gt; temp-&gt;key)</span><br><span class="line">&#123;</span><br><span class="line">temp = temp-&gt;right;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">/* if node==NULL return the minimum node */</span><br><span class="line">return ((node != NULL) ? node : util_rbtree_min(rbtree));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      闲着没事看了看一致性哈希，找了个开源库libconhash看看如何实现。整过过程非常清晰，代码也非常易懂，注释也非常全，带sample，简直就是开源库的典范！！
    
    </summary>
    
    
      <category term="Consistent Hashing" scheme="http://www.liutianhe.com/tags/Consistent-Hashing/"/>
    
  </entry>
  
  <entry>
    <title>java实现多继承(转载)</title>
    <link href="http://www.liutianhe.com/blog/java_implement_muilt_inheritance/"/>
    <id>http://www.liutianhe.com/blog/java_implement_muilt_inheritance/</id>
    <published>2014-07-30T14:54:20.000Z</published>
    <updated>2014-07-30T15:02:33.000Z</updated>
    
    <content type="html"><![CDATA[<p>多重继承指的是一个类可以同时从多于一个的父类那里继承行为和特征，然而我们知道Java为了保证数据安全，它只允许单继承。有些时候我们会认为如果系统中需要使用多重继承往往都是糟糕的设计,这个时候我们往往需要思考的不是怎么使用多重继承,而是您的设计是否存在问题.但有时候我们确实是需要实现多重继承，而且现实生活中也真正地存在这样的情况，比如遗传：我们即继承了父亲的行为和特征也继承了母亲的行为和特征。可幸的是Java是非常和善和理解我们的,它提供了两种方式让我们曲折来实现多重继承：接口和内部类。</p><p>#一、 接口</p><p>在介绍接口和抽象类的时候了解到子类只能继承一个父类，也就是说只能存在单一继承，但是却可以实现多个接口，这就为我们实现多重继承做了铺垫。</p><p>对于接口而已，有时候它所表现的不仅仅只是一个更纯粹的抽象类，接口是没有任何具体实现的，也就是说，没有任何与接口相关的存储，因此也就无法阻止多个接口的组合了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">CanFight</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">fight</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">CanSwim</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">swim</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">CanFly</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActionCharacter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fight</span><span class="params">()</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hero</span> <span class="keyword">extends</span> <span class="title">ActionCharacter</span> <span class="keyword">implements</span> <span class="title">CanFight</span>,<span class="title">CanFly</span>,<span class="title">CanSwim</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">swim</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对于fight()方法，继承父类的，所以不需要显示声明</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>#二、内部类</p><p>上面使用接口实现多重继承是一种比较可行和普遍的方式，在介绍内部类的时候谈到内部类使的多继承的实现变得更加完美了，同时也明确了如果父类为抽象类或者具体类，那么我就仅能通过内部类来实现多重继承了。如何利用内部类实现多重继承，请看下面实例：儿子是如何利用多重继承来继承父亲和母亲的优良基因。</p><p>首先是父亲Father和母亲Mother：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Father</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">strong</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">9</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mother</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">kind</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>重头戏在这里，儿子类Son：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Son</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 内部类继承Father类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Father_1</span> <span class="keyword">extends</span> <span class="title">Father</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">strong</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.strong() + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Mother_1</span> <span class="keyword">extends</span>  <span class="title">Mother</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">kind</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.kind() - <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getStrong</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Father_1().strong();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getKind</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Mother_1().kind();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>儿子继承了父亲，变得比父亲更加强壮，同时也继承了母亲，只不过温柔指数下降了。这里定义了两个内部类，他们分别继承父亲Father类、母亲类Mother类，且都可以非常自然地获取各自父类的行为，这是内部类一个重要的特性：内部类可以继承一个与外部类无关的类，保证了内部类的独立性，正是基于这一点，多重继承才会成为可能。</p>]]></content>
    
    <summary type="html">
    
      多重继承指的是一个类可以同时从多于一个的父类那里继承行为和特征，然而我们知道Java为了保证数据安全，它只允许单继承。有些时候我们会认为如果系统中需要使用多重继承往往都是糟糕的设计,这个时候我们往往需要思考的不是怎么使用多重继承,而是您的设计是否存在问题.但有时候我们确实是需要实现多重继承，而且现实生活中也真正地存在这样的情况，比如遗传：我们即继承了父亲的行为和特征也继承了母亲的行为和特征。可幸的是Java是非常和善和理解我们的,它提供了两种方式让我们曲折来实现多重继承：接口和内部类。
    
    </summary>
    
    
      <category term="java" scheme="http://www.liutianhe.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>访问HubSection中的ListView（windows 8）</title>
    <link href="http://www.liutianhe.com/blog/Access_controls_in_hubsection/"/>
    <id>http://www.liutianhe.com/blog/Access_controls_in_hubsection/</id>
    <published>2014-07-28T14:21:39.000Z</published>
    <updated>2016-10-03T15:08:51.000Z</updated>
    
    <content type="html"><![CDATA[<p>首先一条特别重要的是：<br><strong>在HubSection中的控件是无法在代码中直接访问的。</strong></p><pre><code>&lt;HubSection Width=&quot;800&quot; x:Uid=&quot;Section1Header&quot; Header=&quot;Header&quot;&gt;    &lt;DataTemplate&gt;        &lt;ListView x:Name=&quot;listview&quot;&gt;            &lt;ListView.ItemTemplate&gt;                &lt;DataTemplate&gt;                    &lt;StackPanel Orientation=&quot;Horizontal&quot; &gt;                        &lt;TextBox Text=&quot;{Binding text}&quot;/&gt;                    &lt;/StackPanel&gt;                     &lt;/DataTemplate&gt;            &lt;/ListView.ItemTemplate&gt;        &lt;/ListView&gt;    &lt;/DataTemplate&gt;&lt;/HubSection&gt;</code></pre><p>这样一个ListView如果你像平常一样在代码里</p><pre><code>listView.ItemsSource = someObservableCollection;</code></pre><p>会报错<strong>The name ‘listView’ does not exist in the current context</strong></p><p>一个非常简单的解决办法是在ListView里添加Loaded事件函数。</p><pre><code>&lt;ListView x:Name=&quot;listview&quot; Loaded=&quot;ListView_Loaded&quot;&gt;</code></pre><p>然后添加函数</p><pre><code>private void NotificationList_Loaded(object sender, RoutedEventArgs e){    var listView = (ListView)sender;     listView.ItemsSource = someObservableCollection;}</code></pre><p>总感觉应该有更好的方法。</p>]]></content>
    
    <summary type="html">
    
      首先一条特别重要的是：在HubSection中的控件是无法在代码中直接访问的。
    
    </summary>
    
    
      <category term="windows8开发" scheme="http://www.liutianhe.com/tags/windows8%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>向Windows8应用推送通知(Toast)并响应点击通知事件</title>
    <link href="http://www.liutianhe.com/blog/windows8_app_post_toast_and_launch_browser/"/>
    <id>http://www.liutianhe.com/blog/windows8_app_post_toast_and_launch_browser/</id>
    <published>2014-07-23T14:12:23.000Z</published>
    <updated>2014-08-03T06:49:55.000Z</updated>
    
    <content type="html"><![CDATA[<p>在Mobile Service服务器端推送Toast</p><pre><code>WindowsPushMessage message = new WindowsPushMessage();message.XmlPayload = @&quot;&lt;?xml version=&quot;&quot;1.0&quot;&quot; encoding=&quot;&quot;utf-8&quot;&quot;?&gt;&quot; +                     @&quot;&lt;toast launch=&quot;&quot;toastTest&quot;&quot;&gt;&quot;+  //launch后面的是传输给Onlaunch的参数                     @&quot;&lt;visual&gt;&lt;binding template=&quot;&quot;ToastText01&quot;&quot;&gt;&quot; +                     @&quot;&lt;text id=&quot;&quot;1&quot;&quot;&gt;&quot; + item.Text+&quot;/&quot;+item.UserId+ @&quot;&lt;/text&gt;&quot; +                     @&quot;&lt;/binding&gt;&lt;/visual&gt;&lt;/toast&gt;&quot;;try{    var result = await Services.Push.SendAsync(message);    Services.Log.Info(result.State.ToString());}catch (System.Exception ex){    Services.Log.Error(ex.Message, null, &quot;Push.SendAsync Error&quot;);}</code></pre><p>当你点击Toast时会触发OnLaunched函数，参数内容可以在toast里面指定。这样就可以在OnLaunched根据参数做出指定的操作。</p><pre><code>protected override void OnLaunched(LaunchActivatedEventArgs e){    string launchString = e.Arguments;    if (launchString.Equals(&quot;toastTest&quot;))    {        TestToastLaunchBrowers();    }        …………}</code></pre><p>这里我们通过点击Toast来启动一个外部浏览器并打开一个URL：使用Windows.System.Launcher.LaunchUriAsync(Uri)该方法可以在windows8以及wp8中使用</p><pre><code>async void TestToastLaunchBrowers(){    // Launch the URI    var success = await Windows.System.Launcher.LaunchUriAsync(new Uri(&quot;http://www.bing.com&quot;));}</code></pre><p>参考文献：<br><a href="http://msdn.microsoft.com/en-us/library/windows/apps/xaml/Hh868212(v=win.10" target="_blank" rel="noopener">How to handle activation from a toast notification (XAML)</a>.aspx)</p>]]></content>
    
    <summary type="html">
    
      介绍了如何在Azure中的Mobile Service服务器向Windows 8的客户端推送Toast，并且在客户端针对不同的Toast做出相应的操作。
    
    </summary>
    
    
      <category term="windows8开发" scheme="http://www.liutianhe.com/tags/windows8%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>GZIP is not enough!网站压缩讲座总结</title>
    <link href="http://www.liutianhe.com/blog/gzip_is_not_enough/"/>
    <id>http://www.liutianhe.com/blog/gzip_is_not_enough/</id>
    <published>2014-05-22T12:21:55.000Z</published>
    <updated>2014-08-03T06:01:22.000Z</updated>
    
    <content type="html"><![CDATA[<p>看了一个关于网站压缩的google视频讲座，总结下。<br><a id="more"></a><br>讲座地址：<a href="https://developers.google.com/live/shows/5704036963581952" target="_blank" rel="noopener">GZIP is not enough!</a> (YouTube..需翻墙)<br>PPT：<a href="https://docs.google.com/presentation/d/1TtEKxKLi2pG3OoS8fgCpum_9nPZz_KxgO3UkBdh4bh8/edit#slide=id.p18" target="_blank" rel="noopener">PPT</a>  </p><hr><ul><li><p>虽然一个网站占主要大小的是图片，但HTML,JS,CSS的大小也是在不断增加的，所以文本相关的压缩是十分重要的。</p></li><li><p>推广了一下google的图片格式webp，既可以想PNG一样透明，也可以像JPEG一样有损压缩，甚至可以像GIF一样包含动画。</p></li><li><p>随着各种新技术的诞生，一些JS的体积十分巨大，压缩是必不可少的。</p></li><li><p>讲了讲Minification和Compression的区别，前者仅仅是通过减少可读性来缩小体积，而后者则是重新编码。</p></li><li><p>GZIP原理：LZ77（字典编码的一种）+HUFFMAN（哈夫曼编码）</p></li><li><p>几种压缩算法：GZIP,LZMA,LPAQ,BZIP2互有优劣，但是后面讲了因为整个互联网上可以说只有GZIP是普及了，使用其他压缩算法可能会带来问题。</p></li><li><p>进行预处理，如[0,1,2,3,4,5,6,7,8,9]用GZIP进行压缩体积不会缩小甚至会变大，但是进行delta编码成[0,1,1,1,1,1,1,1,1]转换成差值，重复元素就会很多，压缩也就会很有效率。</p></li><li><p>GZIP会使一些小文件膨胀。</p></li><li><p>PNG的压缩算法和GZIP是一个原理，图片的细微差距会导致压缩体积的巨大区别。</p></li><li><p>可以自己使用7ZIP或Zopfli进行压缩而不是让系统自己压缩，会有大约10%+的优势。</p></li><li><p>网站经常使用JSON来传输数据，通过变换JSON（Transpose JSON）进而缩小体积，例如：</p><blockquote><pre><code>{ “name”: “alex”, “pos”: “AUS”,},{ “name”: “Colt”, “pos”: “USA”,}</code></pre><p>   转换成：</p><pre><code>{ “name”: [“alex”, “colt”], “pos”: [“AUS”, “USA”],}</code></pre><p>不光本身体积小了，也有利于压缩。</p></blockquote></li><li><p>通过Dense Codes算法预处理来优化压缩（Compression boosting）。测试结果Dense Codes+7-Zip效果最好</p></li><li><p>使用Delta.js来传输文件新旧版本之间的的差值（Delta compression）。</p></li><li><p>文件间的水平差值，例如需要传输三个文件file1,file2,file3可以传输fil1,file2-file1,file3-file2。</p></li></ul><hr><p>最后结尾：<br>GZIP is not enough<br>It’s up to you to control your data</p><p>个人一句话总结：基本来说没有万能方法，挨个试一遍选最小的方案吧。。。</p>]]></content>
    
    <summary type="html">
    
      看了一个关于网站压缩的google视频讲座，总结下。
    
    </summary>
    
    
      <category term="web" scheme="http://www.liutianhe.com/tags/web/"/>
    
      <category term="GZIP" scheme="http://www.liutianhe.com/tags/GZIP/"/>
    
  </entry>
  
</feed>
