<!DOCTYPE HTML>

    <html lang="zh-Hans">
  
<head>
  <meta charset="utf-8">
  
  <title>记解决引入CXF的jar包导致异常情况的过程及所学知识 | LucKy_one&#39;s blog</title>
  <meta name="author" content="Liu Tianhe">
  
  <meta name="description" content="在一个老系统中引入了CXF来实现Web Service服务端对外提供服务,却导致了系统原有的调用其他Web Service出现异常。">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="记解决引入CXF的jar包导致异常情况的过程及所学知识"/>
  <meta property="og:site_name" content="LucKy_one&#39;s blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  
    <meta http-equiv="Content-Language" content="zh-Hans"/>
  

  <link href="/img/favicon.ico" rel="icon">
  
    <link rel="apple-touch-icon" href="/img/apple-icon.png">
    <link rel="apple-touch-icon-precomposed" href="/img/apple-icon.png">
    

  <link rel="alternate" href="/atom.xml" title="LucKy_one&#39;s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

  
  <!-- Chinese readability improment -->
  <style type="text/css">
    article {font-weight: 400;letter-spacing: .01rem;}
    article .entry{line-height:2;}
  </style>
  
  
  <style type="text/css">
  /* Tim Pietrusky advanced checkbox hack (Android <= 4.1.2) */
body{ -webkit-animation: bugfix infinite 1s; }
@-webkit-keyframes bugfix { from {padding:0;} to {padding:0;} }
</style>

  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-51092894-1', 'auto');
  ga('send', 'pageview');
 
</script>




  
    
      <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400|Playball' rel='stylesheet' type='text/css'>
    
  <link href='http://apps.bdimg.com/libs/fontawesome/4.1.0/css/font-awesome.css' rel='stylesheet' type='text/css'>
  <script src="http://libs.baidu.com/jquery/1.11.1/jquery.min.js"></script>
  

  <!-- 百度统计  -->
  <script>
  var _hmt = _hmt || [];
  (function() {
   var hm = document.createElement("script");
   hm.src = "https://hm.baidu.com/hm.js?1e76131925f8a8a74864fc1a14e02837";
   var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
  </script>

</head>


<body>
  <header id="header" class="inner"><div class="padding">
	<div class="alignleft logo">
	  <h1><a href="/">LucKy_one&#39;s blog</a></h1>
	</div>
	<nav id="main-nav" class="alignright">
		<input type="checkbox" id="toggle" />
		<label for="toggle" class="toggle" data-open="Main Menu" data-close="Close Menu" onclick><i class="fa fa-bars"></i></label>
	  <ul class="menu">
	    
	      <li><a href="/">Home</a></li>
	    
	      <li><a href="/archives">Archives</a></li>
	    
	      <li><a href="/about">About</a></li>
	    
	    
	    	<li><a href="/atom.xml" target="_blank" title="bruce tan blog rss" class="rss-top"><i class="fa fa-rss"></i></a></li>
	    
	  </ul>
	</nav>
	<div class="clearfix"></div>
</div>
</header>
  <div id="page-heading-wrap">
  	<div class="inner">
      <div class="padding">
    		
          <h1>记解决引入CXF的jar包导致异常情况的过程及所学知识</h1>
          <ul>
            <li>
              <span class="heading-span">Posted on: </span>
              <time datetime="2016-07-08T10:56:23.000Z">2016-07-08</time>
            </li>
            
              <li>
                <span class="heading-span">By: </span>

                
                  <a href="/">Liu Tianhe</a>
                

              </li>
            
          </ul>
        
      </div>
  	</div>
  </div>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper" class="padding"><article class="post">
  
  
    <div class="post-content">
  
      
      <div class="entry">
        
          <p>为了在一个已有系统中实现对外提供Web Service，并在ESB中注册，使用Apache CXF来实现提供服务的功能。在项目中引入了CXF及其依赖的JAR包并修改web.xml和spring的applicationcontext.xml（CXF和Spring集成的真好）之后，发现原有的调用其它Web Service返回的结果中文出现乱码，并且报文头出现了一些区别。逐步排查发现只要引入JAR包就会出现这个问题，于是乎开始深入研究调用Web Service调用过程来定位问题所在。</p>
<p>调用Web Service服务需要WSDL文件以及根据这个WSDL文件生成的jar包,jar包里除了对外暴露的接口类之外，还有一个继承javax.xml.ws.Service的类和一个包含所有可调用方法的接口类。在使用时通过Class.forName(Service的子类)，并通过<code>getConstructor(URL.class, Qname.class).newInstance(XX,XX)</code>来实例化一个Service类，再通过getPort来获取接口的代理类,进而再调用具体的方法。</p>
<p>在对比分析之后，发现引入CXF包的前后，Service类中的delegate的具体实现类发生了变化。开始怀疑是因为引入的CXF的JAR包通过某种方式覆盖了默认的实现类。</p>
<p>最后还是借助了伟大的面向Stackoverflow编程大法:<a href="http://stackoverflow.com/questions/6364333/jax-ws-when-apache-cxf-is-installed-it-steals-default-jdk-jax-ws-implementat" target="_blank" rel="external">JAX-WS = When Apache CXF is installed it “steals” default JDK JAX-WS implementation</a></p>
<h2 id="引用下大牛答案"><a href="#引用下大牛答案" class="headerlink" title="引用下大牛答案:"></a>引用下大牛答案:</h2><p>Apache CXF (<code>cxf-rt-frontend-jaxws-\*.jar</code> to be precise) registers itself as a JAX-WS provider in the JVM.<br>Inside the aforementioned JAR there is a file named: <code>/META-INF/services/javax.xml.ws.spi.Provider</code> with the following contents:<br><code>org.apache.cxf.jaxws.spi.ProviderImpl</code><br>If you now look at javax.xml.ws.spi.FactoryFinder#find method you will discover that JDK searches the CLASSPATH for the presence of javax.xml.ws.spi.Provider file and falls back to default Sun implementation if not available. So you have two options to force fallback:</p>
<ul>
<li>either remove <code>cxf-rt-frontend-jaxws-\*.jar</code> from CLASSPATH</li>
<li>or override <code>javax.xml.ws.spi.Provider</code> file provided by CXF to point to fallback location</li>
</ul>
<p>The second option is actually a bit easier. Simply create:<br><code>/src/main/resources/META-INF/services/javax.xml.ws.spi.Provider</code><br>file (assuming you are using Maven) with the following contents:<br><code>org.apache.cxf.jaxws.spi.ProviderImpl</code><br>That’s it, tested with <code>javax.xml.ws.Endpoint#publish</code>.</p>
<hr>
<p>在CXF的jar包中有这么个文件<code>/META-INF/services/javax.xml.ws.spi.Provider</code>(文件名就是javax.xml.ws.spi.Provider)，内容只有一行<code>org.apache.cxf.jaxws.spi.ProviderImpl</code>。<br>这个时候就涉及到了<strong>JAVA SPI(Service Provider Interface)</strong>技术，简单来说就是通过配置文件来动态指定实现类。<br>这篇博客写的非常浅显易懂:<a href="http://ivanzhangwb.github.io/blog/2012/06/01/java-spi/" target="_blank" rel="external">Java SPI机制简介</a></p>
<p>在删除了CXF的JAR包中的javax.xml.ws.spi.Provider文件之后就一切恢复了正常，但是这并没有很好的解决问题，删除之后使用默认的Provider对CXF的功能有什么影响还有待测试，但起码定位了问题，后续继续研究学习！</p>

        
      </div>
      <footer>
        
          
          
  
  <div class="tags">
    <a href="/tags/JAVA/">JAVA</a>, <a href="/tags/Web-Service/">Web Service</a>, <a href="/tags/CXF/">CXF</a>, <a href="/tags/SPI-Service-Provider-Interface/">SPI(Service Provider Interface)</a>
  </div>

          <div class="share">
  
</div>
          
<nav class="article-nav clearfix">
 
 <div class="article-prev" >
 <a href="/blog/ApacheCXF_on_WebSphere/" title="Apache CXF部署到WebSphere Application Server">
  <i class="fa fa-long-arrow-left"></i>
  <span>
  Apache CXF部署到WebSphere Application Server</span>
</a>
</div>


<div class="article-next">
<a href="/blog/Weighted Random Distribution/"  title="加权随机算法">
 <span>加权随机算法
</span>
<i class="fa fa-long-arrow-right"></i>
</a>
</div>

</nav>

        
        <div class="clearfix"></div>
      </footer>
    </div>
</article>


<section id="comment">
<div id="disqus_thread"></div>
<script>

/*disqus代码*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://www-luckyonecn-com.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>

</section>

</div></div>
    <aside id="sidebar" class="alignright"><div class="padding">
	
	  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:www.luckyonecn.com">
  </form>
</div>
	
	  
<div class="widget recent-post">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/blog/Robo-Advisor/">智能投顾</a>
      </li>
    
      <li>
        <a href="/blog/2017-reading-list/">2017闲书阅读书目</a>
      </li>
    
      <li>
        <a href="/blog/effectively-final-JDK-8/">JDK8中的effectively final</a>
      </li>
    
      <li>
        <a href="/blog/junit-jndi-Spring/">在Spring中使用Junit4测试时访问JNDI资源</a>
      </li>
    
      <li>
        <a href="/blog/spring-h2/">Spring+Maven+H2（Jave配置,非Spring Boot）</a>
      </li>
    
  </ul>
</div>

	
	  
	
	  
<div class="widget tag">
  <h3 class="title">标签</h3>
  
    <a href="/tags/CXF/">CXF<small>2</small></a>
  
    <a href="/tags/Consistent-Hashing/">Consistent Hashing<small>1</small></a>
  
    <a href="/tags/DNS/">DNS<small>1</small></a>
  
    <a href="/tags/DOMAIN/">DOMAIN<small>1</small></a>
  
    <a href="/tags/GZIP/">GZIP<small>1</small></a>
  
    <a href="/tags/Git/">Git<small>1</small></a>
  
    <a href="/tags/H2/">H2<small>1</small></a>
  
    <a href="/tags/JAVA/">JAVA<small>1</small></a>
  
    <a href="/tags/JNDI/">JNDI<small>1</small></a>
  
    <a href="/tags/Junit4/">Junit4<small>1</small></a>
  
    <a href="/tags/Map/">Map<small>1</small></a>
  
    <a href="/tags/SPI-Service-Provider-Interface/">SPI(Service Provider Interface)<small>1</small></a>
  
    <a href="/tags/Spring/">Spring<small>2</small></a>
  
    <a href="/tags/Web-API/">Web API<small>1</small></a>
  
    <a href="/tags/Web-Service/">Web Service<small>2</small></a>
  
    <a href="/tags/WebSphere/">WebSphere<small>1</small></a>
  
    <a href="/tags/WhirlyGlobe/">WhirlyGlobe<small>1</small></a>
  
    <a href="/tags/algorithm/">algorithm<small>2</small></a>
  
    <a href="/tags/hexo/">hexo<small>2</small></a>
  
    <a href="/tags/iOS/">iOS<small>1</small></a>
  
    <a href="/tags/java/">java<small>2</small></a>
  
    <a href="/tags/nodejs/">nodejs<small>1</small></a>
  
    <a href="/tags/sql/">sql<small>1</small></a>
  
    <a href="/tags/web/">web<small>1</small></a>
  
    <a href="/tags/windows8开发/">windows8开发<small>2</small></a>
  
    <a href="/tags/理财/">理财<small>1</small></a>
  
</div>

	
</div></aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="padding">
	<div class="alignleft">
	  
	  &copy; 2018 Liu Tianhe
	  
	  Powerd by <a href="http://hexo.io/" target="_blank">hexo</a>
	  and Theme by <a href="https://github.com/halfer53/metro-light" target="_blank">metro-light</a>
	</div>

	<div class="alignright">
		
		
			<a href="https://github.com/https://github.com/fantasywow" target="_blank" title="Liu Tianhe Github"><i class="fa fa-github-square"></i></a>	
		
		
		
		
		
		
			<a href="/atom.xml" target="_blank" title="Liu Tianhe RSS"><i class="fa fa-rss-square"></i></a>
		
	</div>

	<div class="clearfix"></div>
</div>

<div class="scroll-top"><i class="fa fa-arrow-circle-up"></i></div></footer>
  


<script src="//cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/3.0.4/jquery.imagesloaded.js"></script>
<script src="/js/gallery.js"></script>



<script type="text/javascript">
$(window).scroll(function() {

    if($(this).scrollTop() > 400) {
        $('.scroll-top').fadeIn(200);
    } else {
        $('.scroll-top').fadeOut(200);
    }
});

$('.scroll-top').bind('click', function(e) {
    e.preventDefault();
    $('body,html').animate({scrollTop:0},200);
});
</script>


</body>
</html>
